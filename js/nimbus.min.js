// Generated by CoffeeScript 1.6.2
((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X={}.hasOwnProperty,Y=function(a,b){return function(){return a.apply(b,arguments)}},Z=[].slice,$=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};(function(){var a,b,c;return window.Nimbus==null&&(window.Nimbus={}),a=window.Nimbus,window.handle_initialization=null,a.loaded=!1,window.handleClientLoad=function(){console.log("loaded CALLED"),a.loaded=!0;if(a.gdrive_initialized)return a.Auth.initialize()},b=document.getElementsByTagName("head")[0],c=document.createElement("script"),c.type="text/javascript",c.src="https://apis.google.com/js/client.js?onload=handleClientLoad",b.appendChild(c)})(),c=function(){function a(a){this.client=new d(a)}return a}(),c.ApiError=function(){function a(a,b,c){var d,e;this.method=b,this.url=c,this.status=a.status,a.responseType?e=a.response||a.responseText:e=a.responseText;if(e)try{this.responseText=e.toString(),this.response=JSON.parse(e)}catch(f){d=f,this.response=null}else this.responseText="(no response)",this.response=null}return a.prototype.toString=function(){return"Dropbox API error "+this.status+" from "+this.method+" "+this.url+" :: "+this.responseText},a.prototype.inspect=function(){return this.toString()},a}(),typeof window!="undefined"&&window!==null?window.atob&&window.btoa?(n=function(a){return window.atob(a)},u=function(a){return window.btoa(a)}):(r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",v=function(a,b,c){var d,e;e=3-b,a<<=e*8,d=3;while(d>=e)c.push(r.charAt(a>>d*6&63)),d-=1;d=b;while(d<3)c.push("="),d+=1;return null},o=function(a,b,c){var d,e;e=4-b,a<<=e*6,d=2;while(d>=e)c.push(String.fromCharCode(a>>8*d&255)),d-=1;return null},u=function(a){var b,c,d,e,f,g;e=[],b=0,c=0;for(d=f=0,g=a.length;0<=g?f<g:f>g;d=0<=g?++f:--f)b=b<<8|a.charCodeAt(d),c+=1,c===3&&(v(b,c,e),b=c=0);return c>0&&v(b,c,e),e.join("")},n=function(a){var b,c,d,e,f,g,h;f=[],b=0,d=0;for(e=g=0,h=a.length;0<=h?g<h:g>h;e=0<=h?++g:--g){c=a.charAt(e);if(c==="=")break;b=b<<6|r.indexOf(c),d+=1,d===4&&(o(b,d,f),b=d=0)}return d>0&&o(b,d,f),f.join("")}):(n=function(a){var b,c;return b=new Buffer(a,"base64"),function(){var a,d,e;e=[];for(c=a=0,d=b.length;0<=d?a<d:a>d;c=0<=d?++a:--a)e.push(String.fromCharCode(b[c]));return e}().join("")},u=function(a){var b,c;return b=new Buffer(function(){var b,d,e;e=[];for(c=b=0,d=a.length;0<=d?b<d:b>d;c=0<=d?++b:--b)e.push(a.charCodeAt(c));return e}()),b.toString("base64")}),c.Client=function(){function a(a){this.sandbox=a.sandbox||!1,this.apiServer=a.server||this.defaultApiServer(),this.authServer=a.authServer||this.defaultAuthServer(),this.fileServer=a.fileServer||this.defaultFileServer(),this.oauth=new e(a),this.uid=null,this.authState=null,this.authError=null,this._credentials=null,this.setCredentials(a),this.setupUrls()}return a.prototype.authDriver=function(a){return this.driver=a,this},a.prototype.dropboxUid=function(){return this.uid},a.prototype.credentials=function(){return this._credentials||this.computeCredentials(),this._credentials},a.prototype.authenticate=function(a){var b,e,f=this;return b=null,e=function(){var g;if(b!==f.authState){b=f.authState;if(f.driver.onAuthStateChange)return f.driver.onAuthStateChange(f,e)}switch(f.authState){case d.RESET:return f.requestToken(function(a,b){var c,g;return a?(f.authError=a,f.authState=d.ERROR):(c=b.oauth_token,g=b.oauth_token_secret,f.oauth.setToken(c,g),f.authState=d.REQUEST),f._credentials=null,e()});case d.REQUEST:return g=f.authorizeUrl(f.oauth.token),f.driver.doAuthorize(g,f.oauth.token,f.oauth.tokenSecret,function(){return f.authState=d.AUTHORIZED,f._credentials=null,e()});case d.AUTHORIZED:return f.getAccessToken(function(a,b){return a?(f.authError=a,f.authState=d.ERROR):(f.oauth.setToken(b.oauth_token,b.oauth_token_secret),f.uid=b.uid,f.authState=d.DONE),f._credentials=null,e()});case d.DONE:return a(null,f);case c.SIGNED_OFF:return f.reset(),e();case d.ERROR:return a(f.authError)}},e(),this},a.prototype.signOut=function(a){var b,e,f=this;return e=this.urls.signOut,b=this.oauth.addAuthParams("POST",e,{}),c.Xhr.request("POST",e,b,null,function(b){return b?a(b):(f.reset(),f.authState=d.SIGNED_OFF,f.driver.onAuthStateChange?f.driver.onAuthStateChange(f,function(){return a(b)}):a(b))})},a.prototype.signOff=function(a){return this.signOut(a)},a.prototype.getUserInfo=function(a){var b,d;return d=this.urls.accountInfo,b=this.oauth.addAuthParams("GET",d,{}),c.Xhr.request("GET",d,b,null,function(b,d){return a(b,c.UserInfo.parse(d),d)})},a.prototype.readFile=function(a,b,d){var e,f,g;return!d&&typeof b=="function"&&(d=b,b=null),g=""+this.urls.getFile+"/"+this.urlEncodePath(a),e={},f=null,b&&(b.versionTag?e.rev=b.versionTag:b.rev&&(e.rev=b.rev),b.blob&&(f="blob"),b.binary&&(f="b")),this.oauth.addAuthParams("GET",g,e),c.Xhr.request2("GET",g,e,null,null,f,function(a,b,e){return d(a,b,c.Stat.parse(e))})},a.prototype.writeFile=function(a,b,d,e){var f;return!e&&typeof d=="function"&&(e=d,d=null),f=c.Xhr.canSendForms&&typeof b=="object",f?this.writeFileUsingForm(a,b,d,e):this.writeFileUsingPut(a,b,d,e)},a.prototype.writeFileUsingForm=function(a,b,d,e){var f,g,h,i,j;i=a.lastIndexOf("/"),i===-1?(g=a,a=""):(g=a.substring(i),a=a.substring(0,i)),j=""+this.urls.postFile+"/"+this.urlEncodePath(a),h={file:g};if(d){d.noOverwrite&&(h.overwrite="false");if(d.lastVersionTag)h.parent_rev=d.lastVersionTag;else if(d.parentRev||d.parent_rev)h.parent_rev=d.parentRev||d.parent_rev}return this.oauth.addAuthParams("POST",j,h),delete h.file,f={name:"file",value:b,fileName:g,contentType:"application/octet-stream"},c.Xhr.multipartRequest(j,f,h,null,function(a,b){return e(a,c.Stat.parse(b))})},a.prototype.writeFileUsingPut=function(a,b,d,e){var f,g;g=""+this.urls.putFile+"/"+this.urlEncodePath(a),f={};if(d){d.noOverwrite&&(f.overwrite="false");if(d.lastVersionTag)f.parent_rev=d.lastVersionTag;else if(d.parentRev||d.parent_rev)f.parent_rev=d.parentRev||d.parent_rev}return this.oauth.addAuthParams("POST",g,f),c.Xhr.request2("POST",g,f,null,b,null,function(a,b){return e(a,c.Stat.parse(b))})},a.prototype.stat=function(a,b,d){var e,f;!d&&typeof b=="function"&&(d=b,b=null),f=""+this.urls.metadata+"/"+this.urlEncodePath(a),e={};if(b){b.version!=null&&(e.rev=b.version);if(b.removed||b.deleted)e.include_deleted="true";b.readDir&&(e.list="true",b.readDir!==!0&&(e.file_limit=b.readDir.toString())),b.cacheHash&&(e.hash=b.cacheHash)}return e.include_deleted||(e.include_deleted="false"),e.list||(e.list="false"),this.oauth.addAuthParams("GET",f,e),c.Xhr.request("GET",f,e,null,function(a,b){var e,f,g;return g=c.Stat.parse(b),(b!=null?b.contents:void 0)?e=function(){var a,d,e,g;e=b.contents,g=[];for(a=0,d=e.length;a<d;a++)f=e[a],g.push(c.Stat.parse(f));return g}():e=void 0,d(a,g,e)})},a.prototype.readdir=function(a,b,c){var d;return!c&&typeof b=="function"&&(c=b,b=null),d={readDir:!0},b&&(b.limit!=null&&(d.readDir=b.limit),b.versionTag&&(d.versionTag=b.versionTag)),this.stat(a,d,function(a,b,d){var e,f;return d?e=function(){var a,b,c;c=[];for(a=0,b=d.length;a<b;a++)f=d[a],c.push(f.name);return c}():e=null,c(a,e,b,d)})},a.prototype.metadata=function(a,b,c){return this.stat(a,b,c)},a.prototype.makeUrl=function(a,b,d){var e,f,g;return!d&&typeof b=="function"&&(d=b,b=null),a=this.urlEncodePath(a),b&&b.download?(e=!0,g=""+this.urls.media+"/"+a):(e=!1,g=""+this.urls.shares+"/"+a),b&&(b["long"]||b.longUrl)?f={short_url:"false"}:f={},this.oauth.addAuthParams("POST",g,f),c.Xhr.request("POST",g,f,null,function(a,b){return d(a,c.PublicUrl.parse(b,e))})},a.prototype.history=function(a,b,d){var e,f;return!d&&typeof b=="function"&&(d=b,b=null),f=""+this.urls.revisions+"/"+this.urlEncodePath(a),e={},b&&b.limit!=null&&(e.rev_limit=b.limit),this.oauth.addAuthParams("GET",f,e),c.Xhr.request("GET",f,e,null,function(a,b){var e,f;return b?f=function(){var a,d,f;f=[];for(a=0,d=b.length;a<d;a++)e=b[a],f.push(c.Stat.parse(e));return f}():f=void 0,d(a,f)})},a.prototype.revisions=function(a,b,c){return this.history(a,b,c)},a.prototype.thumbnailUrl=function(a,b){var d,e;return e=""+this.urls.thumbnails+"/"+this.urlEncodePath(a),d={},b&&(b.format?d.format=b.format:b.png&&(d.format="png"),b.size&&(d.size=b.size)),this.oauth.addAuthParams("GET",e,d),""+e+"?"+c.Xhr.urlEncode(d)},a.prototype.readThumbnail=function(a,b,d){var e,f;return!d&&typeof b=="function"&&(d=b,b=null),f=this.thumbnailUrl(a,b),e="b",b&&b.blob&&(e="blob"),c.Xhr.request2("GET",f,{},null,null,e,function(a,b,e){return d(a,b,c.Stat.parse(e))})},a.prototype.revertFile=function(a,b,d){var e,f;return f=""+this.urls.restore+"/"+this.urlEncodePath(a),e={rev:b},this.oauth.addAuthParams("POST",f,e),c.Xhr.request("POST",f,e,null,function(a,b){return d(a,c.Stat.parse(b))})},a.prototype.restore=function(a,b,c){return this.revertFile(a,b,c)},a.prototype.findByName=function(a,b,d,e){var f,g;!e&&typeof d=="function"&&(e=d,d=null),g=""+this.urls.search+"/"+this.urlEncodePath(a),f={query:b};if(d){d.limit!=null&&(f.file_limit=d.limit);if(d.removed||d.deleted)f.include_deleted=!0}return this.oauth.addAuthParams("GET",g,f),c.Xhr.request("GET",g,f,null,function(a,b){var d,f;return b?f=function(){var a,e,f;f=[];for(a=0,e=b.length;a<e;a++)d=b[a],f.push(c.Stat.parse(d));return f}():f=void 0,e(a,f)})},a.prototype.search=function(a,b,c,d){return this.findByName(a,b,c,d)},a.prototype.makeCopyReference=function(a,b){var d,e;return e=""+this.urls.copyRef+"/"+this.urlEncodePath(a),d=this.oauth.addAuthParams("GET",e,{}),c.Xhr.request("GET",e,d,null,function(a,d){return b(a,c.CopyReference.parse(d))})},a.prototype.copyRef=function(a,b){return this.makeCopyReference(a,b)},a.prototype.pullChanges=function(a,b){var d,e;return!b&&typeof a=="function"&&(b=a,a=null),e=this.urls.delta,d={},a?a.cursorTag?d={cursor:a.cursorTag}:d={cursor:a}:d={},this.oauth.addAuthParams("POST",e,d),c.Xhr.request("POST",e,d,null,function(a,d){return b(a,c.PulledChanges.parse(d))})},a.prototype.delta=function(a,b){return this.pullChanges(a,b)},a.prototype.mkdir=function(a,b){var d,e;return e=this.urls.fileopsCreateFolder,d={root:this.fileRoot,path:this.normalizePath(a)},this.oauth.addAuthParams("POST",e,d),c.Xhr.request("POST",e,d,null,function(a,d){return b(a,c.Stat.parse(d))})},a.prototype.remove=function(a,b){var d,e;return e=this.urls.fileopsDelete,d={root:this.fileRoot,path:this.normalizePath(a)},this.oauth.addAuthParams("POST",e,d),c.Xhr.request("POST",e,d,null,function(a,d){return b(a,c.Stat.parse(d))})},a.prototype.unlink=function(a,b){return this.remove(a,b)},a.prototype["delete"]=function(a,b){return this.remove(a,b)},a.prototype.copy=function(a,b,d){var e,f,g;return!d&&typeof e=="function"&&(d=e,e=null),f={root:this.fileRoot,to_path:this.normalizePath(b)},a instanceof c.CopyReference?f.from_copy_ref=a.tag:f.from_path=this.normalizePath(a),g=this.urls.fileopsCopy,this.oauth.addAuthParams("POST",g,f),c.Xhr.request("POST",g,f,null,function(a,b){return d(a,c.Stat.parse(b))})},a.prototype.move=function(a,b,d){var e,f,g;return!d&&typeof e=="function"&&(d=e,e=null),a=this.normalizePath(a),b=this.normalizePath(b),g=this.urls.fileopsMove,f={root:this.fileRoot,from_path:a,to_path:b},this.oauth.addAuthParams("POST",g,f),c.Xhr.request("POST",g,f,null,function(a,b){return d(a,c.Stat.parse(b))})},a.prototype.reset=function(){return this.uid=null,this.oauth.setToken(null,""),this.authState=d.RESET,this.authError=null,this._credentials=null,this},a.prototype.setCredentials=function(a){return this.oauth.reset(a),this.uid=a.uid||null,a.authState?this.authState=a.authState:a.token?this.authState=d.DONE:this.authState=d.RESET,this.authError=null,this._credentials=null,this},a.prototype.appHash=function(){return this.oauth.appHash()},a.prototype.setupUrls=function(){return this.fileRoot=this.sandbox?"sandbox":"dropbox",this.urls={requestToken:""+this.apiServer+"/1/oauth/request_token",authorize:""+this.authServer+"/1/oauth/authorize",accessToken:""+this.apiServer+"/1/oauth/access_token",signOut:""+this.apiServer+"/1/unlink_access_token",accountInfo:""+this.apiServer+"/1/account/info",getFile:""+this.fileServer+"/1/files/"+this.fileRoot,postFile:""+this.fileServer+"/1/files/"+this.fileRoot,putFile:""+this.fileServer+"/1/files_put/"+this.fileRoot,metadata:""+this.apiServer+"/1/metadata/"+this.fileRoot,delta:""+this.apiServer+"/1/delta",revisions:""+this.apiServer+"/1/revisions/"+this.fileRoot,restore:""+this.apiServer+"/1/restore/"+this.fileRoot,search:""+this.apiServer+"/1/search/"+this.fileRoot,shares:""+this.apiServer+"/1/shares/"+this.fileRoot,media:""+this.apiServer+"/1/media/"+this.fileRoot,copyRef:""+this.apiServer+"/1/copy_ref/"+this.fileRoot,thumbnails:""+this.fileServer+"/1/thumbnails/"+this.fileRoot,fileopsCopy:""+this.apiServer+"/1/fileops/copy",fileopsCreateFolder:""+this.apiServer+"/1/fileops/create_folder",fileopsDelete:""+this.apiServer+"/1/fileops/delete",fileopsMove:""+this.apiServer+"/1/fileops/move"}},a.ERROR=0,a.RESET=1,a.REQUEST=2,a.AUTHORIZED=3,a.DONE=4,a.SIGNED_OFF=5,a.prototype.urlEncodePath=function(a){return c.Xhr.urlEncodeValue(this.normalizePath(a)).replace(/%2F/gi,"/")},a.prototype.normalizePath=function(a){var b;if(a.substring(0,1)==="/"){b=1;while(a.substring(b,b+1)==="/")b+=1;return a.substring(b)}return a},a.prototype.requestToken=function(a){var b;return b=this.oauth.addAuthParams("POST",this.urls.requestToken,{}),c.Xhr.request("POST",this.urls.requestToken,b,null,a)},a.prototype.authorizeUrl=function(a){var b;return b={oauth_token:a,oauth_callback:this.driver.url()},""+this.urls.authorize+"?"+c.Xhr.urlEncode(b)},a.prototype.getAccessToken=function(a){var b;return b=this.oauth.addAuthParams("POST",this.urls.accessToken,{}),c.Xhr.request("POST",this.urls.accessToken,b,null,a)},a.prototype.defaultApiServer=function(){return"https://api.dropbox.com"},a.prototype.defaultAuthServer=function(){return this.apiServer.replace("api.","www.")},a.prototype.defaultFileServer=function(){return this.apiServer.replace("api.","api-content.")},a.prototype.computeCredentials=function(){var a;return a={key:this.oauth.key,sandbox:this.sandbox},this.oauth.secret&&(a.secret=this.oauth.secret),this.oauth.token&&(a.token=this.oauth.token,a.tokenSecret=this.oauth.tokenSecret),this.uid&&(a.uid=this.uid),this.authState!==d.ERROR&&this.authState!==d.RESET&&this.authState!==d.DONE&&this.authState!==d.SIGNED_OFF&&(a.authState=this.authState),this.apiServer!==this.defaultApiServer()&&(a.server=this.apiServer),this.authServer!==this.defaultAuthServer()&&(a.authServer=this.authServer),this.fileServer!==this.defaultFileServer()&&(a.fileServer=this.fileServer),this._credentials=a},a}(),d=c.Client,c.AuthDriver=function(){function a(){}return a.prototype.url=function(){return"https://some.url"},a.prototype.doAuthorize=function(a,b,c,d){return d("oauth-token")},a.prototype.onAuthStateChange=function(a,b){return b()},a}(),c.Drivers={},c.Drivers.Redirect=function(){function a(a){this.rememberUser=(a!=null?a.rememberUser:void 0)||!1,this.scope=(a!=null?a.scope:void 0)||"default",this.useQuery=(a!=null?a.useQuery:void 0)||!1,this.receiverUrl=this.computeUrl(a),this.tokenRe=new RegExp("(#|\\?|&)oauth_token=([^&#]+)(&|#|$)")}return a.prototype.url=function(){return this.receiverUrl},a.prototype.doAuthorize=function(a){return window.location.assign(a)},a.prototype.onAuthStateChange=function(a,b){var c,e=this;this.storageKey="dropbox-auth:"+this.scope+":"+a.appHash();switch(a.authState){case d.RESET:if(!(c=this.loadCredentials()))return b();if(c.authState)return c.token===this.locationToken()&&(c.authState===d.REQUEST&&(this.forgetCredentials(),c.authState=d.AUTHORIZED),a.setCredentials(c)),b();if(!this.rememberUser)return this.forgetCredentials(),b();return a.setCredentials(c),a.getUserInfo(function(c){return c&&(a.reset(),e.forgetCredentials()),b()});case d.REQUEST:return this.storeCredentials(a.credentials()),b();case d.DONE:return this.rememberUser&&this.storeCredentials(a.credentials()),b();case d.SIGNED_OFF:return this.forgetCredentials(),b();case d.ERROR:return this.forgetCredentials(),b();default:return b()}},a.prototype.computeUrl=function(){var a,b,d,e;return e="_dropboxjs_scope="+encodeURIComponent(this.scope),b=c.Drivers.Redirect.currentLocation(),b.indexOf("#")===-1?a=null:(d=b.split("#",2),b=d[0],a=d[1]),this.useQuery?b.indexOf("?")===-1?b+="?"+e:b+="&"+e:a="?"+e,a?b+"#"+a:b},a.prototype.locationToken=function(){var a,b,d;return a=c.Drivers.Redirect.currentLocation(),d="_dropboxjs_scope="+encodeURIComponent(this.scope)+"&",(typeof a.indexOf=="function"?a.indexOf(d):void 0)===-1?null:(b=this.tokenRe.exec(a),b?decodeURIComponent(b[2]):null)},a.currentLocation=function(){return window.location.href},a.prototype.storeCredentials=function(a){return localStorage.setItem(this.storageKey,JSON.stringify(a))},a.prototype.loadCredentials=function(){var a,b;b=localStorage.getItem(this.storageKey);if(!b)return null;try{return JSON.parse(b)}catch(c){return a=c,null}},a.prototype.forgetCredentials=function(){return localStorage.removeItem(this.storageKey)},a}(),c.Drivers.Popup=function(){function a(a){this.receiverUrl=this.computeUrl(a),this.tokenRe=new RegExp("(#|\\?|&)oauth_token=([^&#]+)(&|#|$)")}return a.prototype.doAuthorize=function(a,b,c,d){return this.listenForMessage(b,d),this.openWindow(a)},a.prototype.url=function(){return this.receiverUrl},a.prototype.computeUrl=function(a){var b;if(a){if(a.receiverUrl)return a.noFragment||a.receiverUrl.indexOf("#")!==-1?a.receiverUrl:a.receiverUrl+"#";if(a.receiverFile)return b=c.Drivers.Popup.currentLocation().split("/"),b[b.length-1]=a.receiverFile,a.noFragment?b.join("/"):b.join("/")+"#"}return c.Drivers.Popup.currentLocation()},a.currentLocation=function(){return window.location.href},a.prototype.openWindow=function(a){return window.open(a,"_dropboxOauthSigninWindow",this.popupWindowSpec(980,980))},a.prototype.popupWindowSpec=function(a,b){var c,d,e,f,g,h,i,j,k,l;return g=(i=window.screenX)!=null?i:window.screenLeft,h=(j=window.screenY)!=null?j:window.screenTop,f=(k=window.outerWidth)!=null?k:document.documentElement.clientWidth,c=(l=window.outerHeight)!=null?l:document.documentElement.clientHeight,d=Math.round(g+(f-a)/2),e=Math.round(h+(c-b)/2.5),"width="+a+",height="+b+","+("left="+d+",top="+e)+"dialog=yes,dependent=yes,scrollbars=yes,location=yes"},a.prototype.listenForMessage=function(a,b){var c,d;return d=this.tokenRe,c=function(e){var f;f=d.exec(e.data.toString());if(f&&decodeURIComponent(f[2])===a)return window.removeEventListener("message",c),b()},window.addEventListener("message",c,!1)},a}(),c.Drivers.NodeServer=function(){function a(a){this.port=(a!=null?a.port:void 0)||8912,this.faviconFile=(a!=null?a.favicon:void 0)||null,this.fs=require("fs"),this.http=require("http"),this.open=require("open"),this.callbacks={},this.urlRe=new RegExp("^/oauth_callback\\?"),this.tokenRe=new RegExp("(\\?|&)oauth_token=([^&]+)(&|$)"),this.createApp()}return a.prototype.url=function(){return"http://localhost:"+this.port+"/oauth_callback"},a.prototype.doAuthorize=function(a,b,c,d){return this.callbacks[b]=d,this.openBrowser(a)},a.prototype.openBrowser=function(a){if(!a.match(/^https?:\/\//))throw new Error("Not a http/https URL: "+a);return this.open(a)},a.prototype.createApp=function(){var a=this;return this.app=this.http.createServer(function(b,c){return a.doRequest(b,c)}),this.app.listen(this.port)},a.prototype.closeServer=function(){return this.app.close()},a.prototype.doRequest=function(a,b){var c,d,e,f=this;return this.urlRe.exec(a.url)&&(d=this.tokenRe.exec(a.url),d&&(e=decodeURIComponent(d[2]),this.callbacks[e]&&(this.callbacks[e](),delete this.callbacks[e]))),c="",a.on("data",function(a){return c+=a}),a.on("end",function(){return f.faviconFile&&a.url==="/favicon.ico"?f.sendFavicon(b):f.closeBrowser(b)})},a.prototype.closeBrowser=function(a){var b;return b='<!doctype html>\n<script type="text/javascript">window.close();</script>\n<p>Please close this window.</p>',a.writeHead(200,{"Content-Length":b.length,"Content-Type":"text/html"}),a.write(b),a.end},a.prototype.sendFavicon=function(a){return this.fs.readFile(this.faviconFile,function(b,c){return a.writeHead(200,{"Content-Length":c.length,"Content-Type":"image/x-icon"}),a.write(c),a.end})},a}(),s=function(a,b){return m(K(R(a),R(b),a.length,b.length))},t=function(a){return m(Q(R(a),a.length))};if(typeof window=="undefined"||window===null)C=require("crypto"),s=function(a,b){var c;return c=C.createHmac("sha1",b),c.update(a),c.digest("base64")},t=function(a){var b;return b=C.createHash("sha1"),b.update(a),b.digest("base64")};K=function(a,b,c,d){var e,f,g,h;return b.length>16&&(b=Q(b,d)),g=function(){var a,c;c=[];for(f=a=0;a<16;f=++a)c.push(b[f]^909522486);return c}(),h=function(){var a,c;c=[];for(f=a=0;a<16;f=++a)c.push(b[f]^1549556828);return c}(),e=Q(g.concat(a),64+c),Q(h.concat(e),84)},Q=function(a,b){var c,d,e,f,g,h,i,j,k,m,n,o,p,q,r,s,t,u;a[b>>2]|=1<<31-((b&3)<<3),a[(b+8>>6<<4)+15]=b<<3,s=Array(80),c=1732584193,e=-271733879,g=-1732584194,i=271733878,k=-1009589776,o=0,r=a.length;while(o<r){d=c,f=e,h=g,j=i,m=k;for(p=u=0;u<80;p=++u)p<16?s[p]=a[o+p]:s[p]=P(s[p-3]^s[p-8]^s[p-14]^s[p-16],1),p<20?(n=e&g|~e&i,q=1518500249):p<40?(n=e^g^i,q=1859775393):p<60?(n=e&g|e&i|g&i,q=-1894007588):(n=e^g^i,q=-899497514),t=l(l(P(c,5),n),l(l(k,s[p]),q)),k=i,i=g,g=P(e,30),e=c,c=t;c=l(c,d),e=l(e,f),g=l(g,h),i=l(i,j),k=l(k,m),o+=16}return[c,e,g,i,k]},P=function(a,b){return a<<b|a>>>32-b},l=function(a,b){var c,d;return d=(a&65535)+(b&65535),c=(a>>16)+(b>>16)+(d>>16),c<<16|d&65535},m=function(a){var b,c,d,e,f;e="",b=0,d=a.length*4;while(b<d)c=b,f=(a[c>>2]>>(3-(c&3)<<3)&255)<<16,c+=1,f|=(a[c>>2]>>(3-(c&3)<<3)&255)<<8,c+=1,f|=a[c>>2]>>(3-(c&3)<<3)&255,e+=U[f>>18&63],e+=U[f>>12&63],b+=1,b>=d?e+="=":e+=U[f>>6&63],b+=1,b>=d?e+="=":e+=U[f&63],b+=1;return e},U="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",R=function(a){var b,c,d,e,f;b=[],d=255;for(c=e=0,f=a.length;0<=f?e<f:e>f;c=0<=f?++e:--e)b[c>>2]|=(a.charCodeAt(c)&d)<<(3-(c&3)<<3);return b},c.Oauth=function(){function a(a){this.key=this.k=null,this.secret=this.s=null,this.token=null,this.tokenSecret=null,this._appHash=null,this.reset(a)}return a.prototype.reset=function(a){var b,c,d,e;if(a.secret)this.k=this.key=a.key,this.s=this.secret=a.secret,this._appHash=null;else if(a.key)this.key=a.key,this.secret=null,d=n(E(this.key).split("|",2)[1]),e=d.split("?",2),b=e[0],c=e[1],this.k=decodeURIComponent(b),this.s=decodeURIComponent(c),this._appHash=null;else if(!this.k)throw new Error("No API key supplied");return a.token?this.setToken(a.token,a.tokenSecret):this.setToken(null,"")},a.prototype.setToken=function(a,b){if(a&&!b)throw new Error("No secret supplied with the user token");return this.token=a,this.tokenSecret=b||"",this.hmacKey=f.urlEncodeValue(this.s)+"&"+f.urlEncodeValue(b),null},a.prototype.authHeader=function(a,b,c){var d,e,g,h,i,j;this.addAuthParams(a,b,c),e=[];for(g in c)h=c[g],g.substring(0,6)==="oauth_"&&e.push(g);e.sort(),d=[];for(i=0,j=e.length;i<j;i++)g=e[i],d.push(f.urlEncodeValue(g)+'="'+f.urlEncodeValue(c[g])+'"'),delete c[g];return"OAuth "+d.join(",")},a.prototype.addAuthParams=function(a,b,c){return this.boilerplateParams(c),c.oauth_signature=this.signature(a,b,c),c},a.prototype.boilerplateParams=function(a){return a.oauth_consumer_key=this.k,a.oauth_nonce=this.nonce(),a.oauth_signature_method="HMAC-SHA1",this.token&&(a.oauth_token=this.token),a.oauth_timestamp=Math.floor(Date.now()/1e3),a.oauth_version="1.0",a},a.prototype.nonce=function(){return Date.now().toString(36)+Math.random().toString(36)},a.prototype.signature=function(a,b,c){var d;return d=a.toUpperCase()+"&"+f.urlEncodeValue(b)+"&"+f.urlEncodeValue(f.urlEncode(c)),s(d,this.hmacKey)},a.prototype.appHash=function(){return this._appHash?this._appHash:this._appHash=t(this.k).replace(/\=/g,"")},a}(),Date.now==null&&(Date.now=function(){return(new Date).getTime()}),e=c.Oauth,E=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,o;b?(b=[encodeURIComponent(a),encodeURIComponent(b)].join("?"),a=function(){var b,d,e;e=[];for(c=b=0,d=a.length/2;0<=d?b<d:b>d;c=0<=d?++b:--b)e.push((a.charCodeAt(c*2)&15)*16+(a.charCodeAt(c*2+1)&15));return e}()):(l=a.split("|",2),a=l[0],b=l[1],a=n(a),a=function(){var b,d,e;e=[];for(c=b=0,d=a.length;0<=d?b<d:b>d;c=0<=d?++b:--b)e.push(a.charCodeAt(c));return e}(),b=n(b)),f=function(){o=[];for(j=0;j<256;j++)o.push(j);return o}.apply(this),h=0;for(g=k=0;k<256;g=++k)h=(h+f[c]+a[g%a.length])%256,m=[f[h],f[g]],f[g]=m[0],f[h]=m[1];return g=h=0,e=function(){var a,c,e,j;j=[];for(i=a=0,c=b.length;0<=c?a<c:a>c;i=0<=c?++a:--a)g=(g+1)%256,h=(h+f[g])%256,e=[f[h],f[g]],f[g]=e[0],f[h]=e[1],d=f[(f[g]+f[h])%256],j.push(String.fromCharCode((d^b.charCodeAt(i))%256));return j}(),a=function(){var b,d,e;e=[];for(c=b=0,d=a.length;0<=d?b<d:b>d;c=0<=d?++b:--b)e.push(String.fromCharCode(a[c]));return e}(),[u(a.join("")),u(e.join(""))].join("|")},c.PulledChanges=function(){function a(a){var b;this.blankSlate=a.reset||!1,this.cursorTag=a.cursor,this.shouldPullAgain=a.has_more,this.shouldBackOff=!this.shouldPullAgain,a.cursor&&a.cursor.length?this.changes=function(){var d,e,f,g;f=a.entries,g=[];for(d=0,e=f.length;d<e;d++)b=f[d],g.push(c.PullChange.parse(b));return g}():this.changes=[]}return a.parse=function(a){return a&&typeof a=="object"?new c.PulledChanges(a):a},a.prototype.blankSlate=void 0,a.prototype.cursorTag=void 0,a.prototype.changes=void 0,a.prototype.shouldPullAgain=void 0,a.prototype.shouldBackOff=void 0,a}(),c.PullChange=function(){function a(a){this.path=a[0],this.stat=c.Stat.parse(a[1]),this.stat?this.wasRemoved=!1:(this.stat=null,this.wasRemoved=!0)}return a.parse=function(a){return a&&typeof a=="object"?new c.PullChange(a):a},a.prototype.path=void 0,a.prototype.wasRemoved=void 0,a.prototype.stat=void 0,a}(),c.PublicUrl=function(){function a(a,b){this.url=a.url,this.expiresAt=new Date(Date.parse(a.expires)),b===!0?this.isDirect=!0:b===!1?this.isDirect=!1:this.isDirect=Date.now()-this.expiresAt<=864e5,this.isPreview=!this.isDirect}return a.parse=function(a,b){return a&&typeof a=="object"?new c.PublicUrl(a,b):a},a.prototype.url=void 0,a.prototype.expiresAt=void 0,a.prototype.isDirect=void 0,a.prototype.isPreview=void 0,a}(),c.CopyReference=function(){function a(a){typeof a=="object"?(this.tag=a.copy_ref,this.expiresAt=new Date(Date.parse(a.expires))):(this.tag=a,this.expiresAt=new Date)}return a.parse=function(a){return!a||typeof a!="object"&&typeof a!="string"?a:new c.CopyReference(a)},a.prototype.tag=void 0,a.prototype.expiresAt=void 0,a}(),c.Stat=function(){function a(a){var b,c,d,e;this.path=a.path,this.path.substring(0,1)!=="/"&&(this.path="/"+this.path),b=this.path.length-1,b>=0&&this.path.substring(b)==="/"&&(this.path=this.path.substring(0,b)),c=this.path.lastIndexOf("/"),this.name=this.path.substring(c+1),this.isFolder=a.is_dir||!1,this.isFile=!this.isFolder,this.isRemoved=a.is_deleted||!1,this.typeIcon=a.icon,((d=a.modified)!=null?d.length:void 0)?this.modifiedAt=new Date(Date.parse(a.modified)):this.modifiedAt=null,((e=a.client_mtime)!=null?e.length:void 0)?this.clientModifiedAt=new Date(Date.parse(a.client_mtime)):this.clientModifiedAt=null;switch(a.root){case"dropbox":this.inAppFolder=!1;break;case"app_folder":this.inAppFolder=!0;break;default:this.inAppFolder=null}this.size=a.bytes||0,this.humanSize=a.size||"",this.hasThumbnail=a.thumb_exists||!1,this.isFolder?(this.versionTag=a.hash,this.mimeType=a.mime_type||"inode/directory"):(this.versionTag=a.rev,this.mimeType=a.mime_type||"application/octet-stream")}return a.parse=function(a){return a&&typeof a=="object"?new c.Stat(a):a},a.prototype.path=null,a.prototype.name=null,a.prototype.inAppFolder=null,a.prototype.isFolder=null,a.prototype.isFile=null,a.prototype.isRemoved=null,a.prototype.typeIcon=null,a.prototype.versionTag=null,a.prototype.mimeType=null,a.prototype.size=null,a.prototype.humanSize=null,a.prototype.hasThumbnail=null,a.prototype.modifiedAt=null,a.prototype.clientModifiedAt=null,a}(),c.UserInfo=function(){function a(a){var b;this.name=a.display_name,this.email=a.email,this.countryCode=a.country||null,this.uid=a.uid.toString(),a.public_app_url?(this.publicAppUrl=a.public_app_url,b=this.publicAppUrl.length-1,b>=0&&this.publicAppUrl.substring(b)==="/"&&(this.publicAppUrl=this.publicAppUrl.substring(0,b))):this.publicAppUrl=null,this.referralUrl=a.referral_link,this.quota=a.quota_info.quota,this.privateBytes=a.quota_info.normal||0,this.sharedBytes=a.quota_info.shared||0,this.usedQuota=this.privateBytes+this.sharedBytes}return a.parse=function(a){return a&&typeof a=="object"?new c.UserInfo(a):a},a.prototype.name=null,a.prototype.email=null,a.prototype.countryCode=null,a.prototype.uid=null,a.prototype.referralUrl=null,a.prototype.publicAppUrl=null,a.prototype.quota=null,a.prototype.usedQuota=null,a.prototype.privateBytes=null,a.prototype.sharedBytes=null,a}(),typeof window!="undefined"&&window!==null?!window.XDomainRequest||"withCredentials"in new XMLHttpRequest?(i=window.XMLHttpRequest,h=!1,g=window.navigator.userAgent.indexOf("Firefox")===-1):(i=window.XDomainRequest,h=!0,g=!1):(i=require("xmlhttprequest").XMLHttpRequest,h=!1,g=!1),c.Xhr=function(){function a(){}return a.Request=i,a.ieMode=h,a.canSendForms=g,a.request=function(a,b,c,d,e){return this.request2(a,b,c,d,null,null,e)},a.request2=function(a,b,c,d,e,g,h){var i,j,k;return j=a==="GET"||e!=null||this.ieMode,j&&(k=f.urlEncode(c),k.length!==0&&(b=[b,"?",f.urlEncode(c)].join(""))),i={},d&&(i.Authorization=d),e!=null?typeof e=="string"&&(i["Content-Type"]="text/plain; charset=utf8"):j||(i["Content-Type"]="application/x-www-form-urlencoded",e=f.urlEncode(c)),f.xhrRequest(a,b,i,e,g,h)},a.multipartRequest=function(a,b,c,d,e){var g,h,i,j,k,l;return a=[a,"?",f.urlEncode(c)].join(""),i=b.value,l=typeof i=="object"&&(typeof Blob!="undefined"&&Blob!==null&&b.value instanceof Blob||typeof File!="undefined"&&File!==null&&b.value instanceof File),l?(k={},g=new FormData,g.append(b.name,i,b.fileName)):(j=b.contentType||"application/octet-stream",h=this.multipartBoundary(),k={"Content-Type":"multipart/form-data; boundary="+h},g=["--",h,"\r\n",'Content-Disposition: form-data; name="',b.name,'"; filename="',b.fileName,'"\r\n',"Content-Type: ",j,"\r\n","Content-Transfer-Encoding: binary\r\n\r\n",i,"\r\n","--",h,"--","\r\n"].join("")),d&&(k.Authorization=d),f.xhrRequest("POST",a,k,g,null,e)},a.multipartBoundary=function(){return[Date.now().toString(36),Math.random().toString(36)].join("----")},a.xhrRequest=function(a,b,c,d,e,g){var h,i,j;j=new this.Request,this.ieMode?(j.onload=function(){return f.onLoad(j,a,b,g)},j.onerror=function(){return f.onError(j,a,b,g)}):j.onreadystatechange=function(){return f.onReadyStateChange(j,a,b,e,g)},j.open(a,b,!0),e&&(e==="b"?j.overrideMimeType&&j.overrideMimeType("text/plain; charset=x-user-defined"):j.responseType=e);if(!this.ieMode)for(h in c){if(!X.call(c,h))continue;i=c[h],j.setRequestHeader(h,i)}return d!=null?j.send(d):j.send(),j},a.urlEncode=function(a){var b,c,d;b=[];for(c in a)d=a[c],b.push(this.urlEncodeValue(c)+"="+this.urlEncodeValue(d));return b.sort().join("&")},a.urlEncodeValue=function(a){return encodeURIComponent(a.toString()).replace(/\!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")},a.urlDecode=function(a){var b,c,d,e,f,g;c={},g=a.split("&");for(e=0,f=g.length;e<f;e++)d=g[e],b=d.split("="),c[decodeURIComponent(b[0])]=decodeURIComponent(b[1]);return c},a.onReadyStateChange=function(a,b,d,e,g){var h,i,j,k,l,m,n,o,p,q;if(a.readyState!==4)return!0;if(a.status<200||a.status>=300)return h=new c.ApiError(a,b,d),g(h),!0;n=a.getResponseHeader("x-dropbox-metadata");if(n!=null?n.length:void 0)try{m=JSON.parse(n)}catch(r){k=r,m=void 0}else m=void 0;if(e){if(e==="b"){j=a.responseText!=null?a.responseText:a.response,i=[];for(l=p=0,q=j.length;0<=q?p<q:p>q;l=0<=q?++p:--p)i.push(String.fromCharCode(j.charCodeAt(l)&255));o=i.join(""),g(null,o,m)}else g(null,a.response,m);return!0}o=a.responseText!=null?a.responseText:a.response;switch(a.getResponseHeader("Content-Type")){case"application/x-www-form-urlencoded":g(null,f.urlDecode(o),m);break;case"application/json":case"text/javascript":g(null,JSON.parse(o),m);break;default:g(null,o,m)}return!0},a.onLoad=function(a,b,c,d){var e;e=a.responseText;switch(a.contentType){case"application/x-www-form-urlencoded":d(null,f.urlDecode(e),void 0);break;case"application/json":case"text/javascript":d(null,JSON.parse(e),void 0);break;default:d(null,e,void 0)}return!0},a.onError=function(a,b,d,e){var f;return f=new c.ApiError(a,b,d),e(f),!0},a}(),f=c.Xhr;if((typeof module!=="undefined"&&module!==null?module.exports:void 0)!=null)module.exports=c;else if(typeof window!="undefined"&&
window!==null)window.Dropbox=c;else throw new Error("This library only supports node.js and modern browsers.");c.atob=n,c.btoa=u,c.hmac=s,c.sha1=t,c.encodeKey=E,function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;return window.Nimbus==null&&(i=winodw.Nimbus={}),i=window.Nimbus,i.version="0.0.1",a=i.$=this.jQuery||this.Zepto||function(){return arguments[0]},i.dictModel={},l=function(a){return Array.prototype.slice.call(a,0)},k=function(a){return Object.prototype.toString.call(a)==="[object Array]"},typeof Array.prototype.indexOf=="undefined"&&(Array.prototype.indexOf=function(a){var b;b=0;while(b<this.length){if(this[b]===a)return b;b++}return-1}),g={bind:function(a,b){var c,d,e;d=a.split(" "),c=this._callbacks||(this._callbacks={}),e=0;while(e<d.length)(this._callbacks[d[e]]||(this._callbacks[d[e]]=[])).push(b),e++;return this},trigger:function(){var a,b,c,d,e,f;a=l(arguments),c=a.shift();if(!(b=this._callbacks))return!1;if(!(f=this._callbacks[c]))return!1;d=0,e=f.length;while(d<e){if(f[d].apply(this,a)===!1)return!1;d++}return!0},unbind:function(a,b){var c,d,e,f;if(!a)return this._callbacks={},this;if(!(c=this._callbacks))return this;if(!(f=c[a]))return this;if(!b)return delete this._callbacks[a],this;d=0,e=f.length;while(d<e){if(b===f[d]){f=f.slice(),f.splice(d,1),c[a]=f;break}d++}return this}},typeof Object.create!="function"&&(Object.create=function(a){var b;return b=function(){},b.prototype=a,new b}),m=["included","extended"],d={inherited:function(){},created:function(){},prototype:{initialize:function(){},init:function(){}},create:function(a,b){var c;return c=Object.create(this),c.parent=this,c.prototype=c.fn=Object.create(this.prototype),a&&c.include(a),b&&c.extend(b),c.created(),this.inherited(c),c},init:function(){var a;return a=Object.create(this.prototype),a.parent=this,a.initialize.apply(a,arguments),a.init.apply(a,arguments),a},proxy:function(a){var b;return b=this,function(){return a.apply(b,arguments)}},proxyAll:function(){var a,b,c;a=l(arguments),b=0,c=[];while(b<a.length)this[a[b]]=this.proxy(this[a[b]]),c.push(b++);return c},include:function(a){var b,c;for(c in a)m.indexOf(c)===-1&&(this.fn[c]=a[c]);return b=a.included,b&&b.apply(this),this},extend:function(a){var b,c;for(c in a)m.indexOf(c)===-1&&(this[c]=a[c]);return b=a.extended,b&&b.apply(this),this}},d.prototype.proxy=d.proxy,d.prototype.proxyAll=d.proxyAll,d.inst=d.init,d.sub=d.create,i.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b,c;return b=Math.random()*16|0,c=a==="x"?b:b&3|8,c.toString(16)}).toUpperCase()},b=i.Auth=d.create(),b.extend({reinitialize:function(){log("reintialize called");if(localStorage["service"]!=null)return log("the service exists",localStorage.service),this.setup(localStorage.service,localStorage.d_key,localStorage.secret,localStorage.app_name),this.initialize()},setup:function(a,b,c,d,e){typeof a=="string"&&(b==null||c==null||d==null)&&(a=JSON.parse(Base64.decode(a)));if(typeof a=="string"){log("setup called"),this.service=a,this.key=b,this.secret=c,this.app_name=d,e!=null&&(this.client_secret=e),localStorage.service=this.service,localStorage.d_key=this.key,localStorage.secret=this.secret,localStorage.app_name=this.app_name,e!=null&&(localStorage.client_secret=this.client_secret);switch(this.service){case"Dropbox":this.extend(i.Auth.Dropbox_auth),this.authorize=this.proxy(this.authenticate_dropbox),this.initialize=this.proxy(this.initialize_dropbox),this.authorized=this.proxy(this.dropbox_authorized),this.logout=this.proxy(this.logout_dropbox),log("service is dropbox");break;case"GDrive":this.extend(i.Auth.GDrive),this.authorize=this.proxy(this.authenticate_gdrive),this.initialize=this.proxy(this.initialize_gdrive),this.authorized=this.proxy(this.gdrive_authorized),this.logout=this.proxy(this.logout_gdrive),log("service is GDrive"),i.Share.setup(this.service);break;default:log("Invalid service name")}i.Binary.setup(this.service)}else typeof a=="object"&&(log("new method for setup, the service is there"),this.sync_services=a,this.models={},localStorage["service"]!=null?localStorage.service==="GDrive"?this.setup(localStorage.service,localStorage.d_key,localStorage.secret,localStorage.app_name,localStorage.client_secret):this.setup(localStorage.service,localStorage.d_key,localStorage.secret,localStorage.app_name):(this.extend(i.Auth.Multi),this.authorize=this.proxy(this.authenticate_service),this.initialize=this.proxy(this.initialize_service)))},authorized:function(){return log("authorized not yet setup")},state:function(){return localStorage.state},authorize:function(){return log("authorize not yet setup")},initialize:function(){return log("initialize not setup")},authorized_callback:function(){return log("authorized callback undefined")},app_ready_func:function(){return log("app_ready"),this.app_ready=!0},set_app_ready:function(a){return log("set app ready"),this.app_ready!=null&&this.app_ready?a():this.app_ready_func=a},logout:function(){return log("logout not implemented")}}),e=i.Client=d.create(),j=i.Share=d.create(),j.extend({setup:function(a){switch(a){case"GDrive":return log("share api with GDrive"),this.extend(i.Client.GDrive),this.get_users=this.proxy(this.get_shared_users),this.add_user=this.proxy(this.add_share_user),this.remove_user=this.proxy(this.remove_share_user),this.get_me=this.proxy(this.get_current_user),this.get_spaces=this.proxy(this.get_app_folders),this.switch_spaces=this.proxy(this.switch_to_app_folder);default:return log("share not supported with this service")}},get_users:function(){return log("users not implemented")},add_user:function(a){return log("add a user")},remove_user:function(a){return log("removed user")},get_me:function(){return log("get currently logged user")},get_spaces:function(){return log("get current spaces")},switch_spaces:function(a){return log("switch space")}}),c=i.Binary=d.create(),c.extend({setup:function(a){log("binary setup called");switch(a){case"Dropbox":return this.extend(i.Client.Dropbox.Binary),i.Client.Dropbox.Binary.binary_setup(),log("service is dropbox");case"GDrive":return this.extend(i.Client.GDrive.Binary),i.Client.GDrive.Binary.binary_setup(),log("service is GDrive");default:return log("Invalid service name")}},upload_blob:function(a,b,c){return log("upload blob")},upload_file:function(a,b){return log("upload blob")},read_file:function(a,b){return log("read file")},share_link:function(a,b){return log("share link")},direct_link:function(a,b){return log("direct link")},delete_file:function(a){return log("delete file")}}),f=i.DB=d.create(),f.extend(g),f.extend({setup_db:function(a){log("setup db");switch(a){case"localStorage":return Storage.prototype.setItem=function(a,b){return this===window.localStorage?log("local storage called"):_setItem.apply(this,arguments)}}}}),h=i.Model=d.create(),h.extend(g),h.extend({service_setup:function(a){var b;log("service setup model",a),b=a.attributes;switch(i.Auth.service){case"Dropbox":log("extend as Dropbox"),a.extend(i.Model.general_sync),a.extend(i.Model.Dropbox),b.push("synced"),b.push("time"),a.attributes=b;break;case"GDrive":log("extend as GDrive"),a.extend(i.Model.general_sync),a.extend(i.Model.GDrive),b.push("gid"),b.push("synced"),b.push("time"),a.attributes=b,window.model_initialize(a);break;default:log("Invalid service name")}return a},setup:function(a,b){var c,d;return log("model setup"),d=h.sub(),a&&(d.name=a),b&&(d.attributes=b),d.extend(i.Model.Local),i.Auth.service!=null||i.Auth.sync_services!=null||a==="binary"||a==="binary_Deletion"?(log("model 1",d),a.indexOf("_Deletion")<0&&(d=this.service_setup(d))):(log("name:",a),log("Please setup Nimbus.Auth first before creating models")),a.indexOf("_Deletion")<0&&(c=i.Model.setup(a+"_"+"Deletion",["deletion_id","listid"]),c.extend(i.Model.Local),c.fetch(),d.DeletionStorage=c),log(d),d.fetch(),a.indexOf("_Deletion")<0&&(i.dictModel[a]=d),d},created:function(a){return this.records={},this.attributes=this.attributes?l(this.attributes):[]},find:function(a){var b;b=this.records[a];if(!b)throw"Unknown record";return b.clone()},exists:function(a){var b;try{return this.find(a)}catch(c){return b=c,!1}},refresh:function(a){var b,c,d;a=this.fromJSON(a),this.records={},b=0,c=a.length;while(b<c)d=a[b],d.newRecord=!1,this.records[d.id]=d,b++;return this.trigger("refresh"),this},select:function(a){var b,c;c=[];for(b in this.records)a(this.records[b])&&c.push(this.records[b]);return this.cloneArray(c)},findByAttribute:function(a,b){var c;for(c in this.records)if(this.records[c][a]===b)return this.records[c].clone()},findAllByAttribute:function(a,b){return this.select(function(c){return c[a]===b})},each:function(a){var b,c;c=[];for(b in this.records)c.push(a(this.records[b]));return c},all:function(){return this.cloneArray(this.recordsValues())},first:function(){var a;return a=this.recordsValues()[0],a&&a.clone()},last:function(){var a,b;return b=this.recordsValues(),a=b[b.length-1],a&&a.clone()},count:function(){return this.recordsValues().length},deleteAll:function(){var a,b;b=[];for(a in this.records)b.push(delete this.records[a]);return b},destroyAll:function(){var a,b;b=[];for(a in this.records)b.push(this.records[a].destroy());return b},update:function(a,b){return this.find(a).updateAttributes(b)},create:function(a){var b;return b=this.init(a),b.save()},destroy:function(a){return this.find(a).destroy()},sync:function(a){return this.bind("change",a)},fetch:function(a){return typeof a=="function"?this.bind("fetch",a):this.trigger.apply(this,["fetch"].concat(l(arguments)))},toJSON:function(){return this.recordsValues()},fromJSON:function(a){var b,c;if(!a)return;typeof a=="string"&&(a=JSON.parse(a));if(k(a)){c=[],b=0;while(b<a.length)c.push(this.init(a[b])),b++;return c}return this.init(a)},recordsValues:function(){var a,b;b=[];for(a in this.records)b.push(this.records[a]);return b},cloneArray:function(a){var b,c;c=[],b=0;while(b<a.length)c.push(a[b].clone()),b++;return c}}),h.include({model:!0,newRecord:!0,init:function(a){return a&&this.load(a),this.trigger("init",this)},isNew:function(){return this.newRecord},isValid:function(){return!this.validate()},validate:function(){},load:function(a){var b,c;c=[];for(b in a)c.push(this[b]=a[b]);return c},attributes:function(){var a,b,c;c={},b=0;while(b<this.parent.attributes.length)a=this.parent.attributes[b],c[a]=this[a],b++;return c.id=this.id,c},eql:function(a){return a&&a.id===this.id&&a.parent===this.parent},save:function(){var a;return a=this.validate(),a?(this.trigger("error",this,a),!1):(this.trigger("beforeSave",this),this.newRecord?this.create():this.update(),this.trigger("save",this),this)},updateAttribute:function(a,b){return this[a]=b,this.save()},updateAttributes:function(a){return this.load(a),this.save()},destroy:function(){return this.trigger("beforeDestroy",this),delete this.parent.records[this.id],this.destroyed=!0,this.trigger("destroy",this),this.trigger("change",this,"destroy")},dup:function(){var a;return a=this.parent.init(this.attributes()),a.newRecord=this.newRecord,a},clone:function(){return Object.create(this)},reload:function(){var a;return this.newRecord?this:(a=this.parent.find(this.id),this.load(a.attributes()),a)},toJSON:function(){return this.attributes()},exists:function(){return this.id&&this.id in this.parent.records},update:function(){var a,b;return this.trigger("beforeUpdate",this),b=this.parent.records,b[this.id].load(this.attributes()),a=b[this.id].clone(),this.trigger("update",a),this.trigger("change",a,"update")},create:function(){var a,b;return this.trigger("beforeCreate",this),this.id||(this.id=i.guid()),this.newRecord=!1,b=this.parent.records,b[this.id]=this.dup(),a=b[this.id].clone(),this.trigger("create",a),this.trigger("change",a,"create")},bind:function(a,b){return this.parent.bind(a,this.proxy(function(a){if(a&&this.eql(a))return b.apply(this,arguments)}))},trigger:function(){return this.parent.trigger.apply(this.parent,arguments)}})}(),k=function(){function a(a){this._set=a===void 0?[]:a,this.length=this._set.length,this.contains=function(a){return this._set.indexOf(a)!==-1}}return a.prototype.union=function(a){var b,c,d,e;b=a.length>this.length?a:this,c=a.length>this.length?this:a,e=b.copy(),d=0;while(d<c.length)e.add(c._set[d]),d++;return e},a.prototype.intersection=function(b){var c,d,e,f,g;g=new a,c=b.length>this.length?b:this,d=b.length>this.length?this:b,f=0;while(f<d.length)e=d._set[f],c.contains(e)&&g.add(e),f++;return g},a.prototype.difference=function(b){var c,d,e;e=new a,d=0;while(d<this.length)c=this._set[d],b.contains(c)||e.add(c),d++;return e},a.prototype.symmetricDifference=function(a){return this.union(a).difference(this.intersection(a))},a.prototype.isSuperSet=function(a){var b;b=0;while(b<a.length){if(!this.contains(a._set[b]))return!1;b++}return!0},a.prototype.isSubSet=function(a){var b;b=0;while(b<this.length){if(!a.contains(this._set[b]))return!1;b++}return!0},a.prototype.add=function(a){return this._set.indexOf(a)===-1&&(this._set.push(a),this.length++),this.length},a.prototype.remove=function(a){var b;return b=this._set.indexOf(a),b!==-1?(this.length--,this._set.splice(b,1)[0]):null},a.prototype.copy=function(){return new a(this._set.slice())},a.prototype.asArray=function(){return this._set},a}(),H=this,H.Set=k,a=function(){function a(a){this.callback=a,this.ready=Y(this.ready,this),this.ok=Y(this.ok,this),this.wait=Y(this.wait,this),this.count=1}return a.prototype.wait=function(){return this.count++},a.prototype.ok=function(){if(!--this.count)return this.callback()},a.prototype.ready=function(){return this.ok()},a}(),j=function(){function a(){this.execute_callback=Y(this.execute_callback,this),this.add_last_call=Y(this.add_last_call,this),this.add_call=Y(this.add_call,this),this.running=!1,this.callbacks=[]}return a.prototype.add_call=function(a){return this.running=!0,this.callbacks.push(a)},a.prototype.add_last_call=function(a){return this.last_callback=a},a.prototype.execute_callback=function(){var a,b,c,d;d=this.callbacks;for(b=0,c=d.length;b<c;b++)a=d[b],a();return this.callbacks=[],this.last_callback!=null&&this.last_callback(),this.running=!1},a}(),b=function(){function a(){this.ready=Y(this.ready,this),this.ok=Y(this.ok,this),this.wait=Y(this.wait,this),this.count=1}return a.prototype.wait=function(){return this.count++},a.prototype.ok=function(){if(!--this.count)return log("ok executed")},a.prototype.ready=function(){return this.ok()},a}(),H=this,H.DelayedOp=a,H.OneOp=j,H.DelayedSyncAnimation=b,window.debug=!1,window.log=function(){var a;a=1<=arguments.length?Z.call(arguments,0):[];if(window.debug)return console.log(a)},window.one_time_sync=!1,window.keys=function(a){var b,c,d;c=[];for(b in a)d=a[b],c.push(b);return c},Nimbus.Model.general_sync={cloudcache:{},create_object_dictionary:function(){var a,b,c,d,e;a={},log("object:",this),e=this.all();for(c=0,d=e.length;c<d;c++)b=e[c],a[b.id]=b;return a},sync_model_base_algo:function(){var a,b,c,d,e,f,g,h,i,j,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;log("#ONE TIME SYNC ALGO RUNNING",this.name),window.one_time_sync=!0,window.currently_syncing=!0,i=this.create_object_dictionary(),a=this.cloudcache,l=new k(keys(i)),b=new k(keys(a)),log("local_set",l),log("cloud_set",b),d=[],x=this.DeletionStorage.all();for(p=0,t=x.length;p<t;p++)f=x[p],this.delete_from_cloud(f.id),d.push(f.id),f.destroy();e=new k(d),log("deleted set",e),log("#the set of ids that are there locally but not there on the cloud",l.difference(b)._set),y=l.difference(b)._set;for(q=0,u=y.length;q<u;q++)h=y[q],j=i[h],j["synced"]!=null&&j.synced?(log("id for deletion",h),i[h].destroy()):this.add_to_cloud(j);log("#the set of ids that are there on the cloud but not there locally minus deletions",b.difference(l).difference(e)._set),z=b.difference(l).difference(e)._set;for(r=0,v=z.length;r<v;r++)h=z[r],this.add_from_cloud(h);log("#the set of ids that are there in the cloud and locally",b.intersection(l)._set),n=[],o=[],g=[],A=b.intersection(l)._set;for(s=0,w=A.length;s<w;s++)h=A[s],m=new Date(i[h].time),c=new Date(a[h].time),log("local_time",m.toString()),log("cloud_time",c.toString()),m-c===0?(log("equal time stamp do nothin",a[h].title),g.push(h)):m-c>0?(this.update_to_cloud(i[h]),n.push(h)):(this.update_to_local(i[h]),o.push(h));return window.currently_syncing=!1,window.one_time_sync=!1,log("updated to cloud",n.length,n),log("updated to local",o.length,o),log("equal timestamp",g.length,g)},real_time_sync:function(a,b,c){var d,e;log("method",b),log("record",a),this.saveLocal();if(window.currently_syncing)return!0;b==="update"&&(this.records[a.id].time=(new Date).toString()),e=navigator.onLine&&(localStorage.state==="Working"||Nimbus.Client.GDrive.check_auth());if(!e)return console.log("syncing is not setup correctly or the instance is not online"),!0;switch(b){case"destroy":if(a.synced)return e?(log("deletion in cloud"),this.delete_from_cloud(a.id)):(d=Deletion.init({id:a.id}),d.save());break;case"create":return this.add_to_cloud(a,function(){});case"update":return this.update_to_cloud(a,function(){});case"read":return this.update_to_local(a,function(){});default:return log("REAL TIME SYNCING FAILED, THIS METHOD NOT IMPLEMENTED")}},delta_update:function(){var a;return a=this.get_delta}},Nimbus.Model.Local={extended:function(){return this.sync(this.proxy(this.saveLocal)),this.fetch(this.proxy(this.loadLocal))},saveLocal:function(){var a;return a=JSON.stringify(this),localStorage[this.name]=a},loadLocal:function(){var a;a=localStorage[this.name];if(!a)return;return a=JSON.parse(a),this.refresh(a)}},Nimbus.Model.Dropbox={cloudcache:{},last_hash:"",hash:"",toCloudStructure:function(a){return log("local to cloud structure"),JSON.stringify(a)},fromCloudStructure:function(a){return log("changes cloud to local data in the form a dictionary"),a},diff_objects:function(a,b){var c,d,e;c={};for(d in a)e=a[d],b[d]!==a[d]&&(c[d]=[b[d],a[d]]);return a["parent_id"]!=null!=(b["parent_id"]!=null)&&(c.parent_id=["one of them is null"]),c},add_to_cloud:function(a,b){return log("add to cloud",a.name),Nimbus.Client.Dropbox.putFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+a.id+".txt"),this.toCloudStructure(a),function(c){log(a.name,"finished being added to cloud"),log("resp",c),window.currently_syncing=!0,a.time=c.modified,a.synced=!0,a.save(),window.currently_syncing=!1;if(b!=null)return b(c)})},delete_from_cloud:function(a,b){return log("delete from cloud",a),log("delete route","/"+Nimbus.Auth.app_name+("/"+this.name+"/"+a+".txt")),Nimbus.Client.Dropbox.deletePath("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+a+".txt"),function(){log("finished delete from cloud",a);if(b!=null)return b()})},update_to_cloud:function(a,b){return log("updated to cloud",a.name),Nimbus.Client.Dropbox.putFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+a.id+".txt"),this.toCloudStructure(a),function(c){log(a.name,"finished being updated to cloud"),window.currently_syncing=!0,a.time=c.modified,a.synced=!0,a.save(),window.currently_syncing=!1;if(b!=null)return b(c)})},add_from_cloud:function(a,b){var c=this;return log("add from cloud",a),Nimbus.Client.Dropbox.getFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+a+".txt"),function(d){var e,f;log("cloud read data",d),window.currently_syncing=!0,e=c.fromCloudStructure(d),f=c.init(e),f.synced=!0,f.time=c.cloudcache[a].time,f.save(),window.currently_syncing=!1;if(b!=null)return b(d)})},update_to_local:function(a,b){var c=this;return log("update to local",a.name),Nimbus.Client.Dropbox.getFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+a.id+".txt"),function(b){var d,e;return log("cloud read data",b),window.currently_syncing=!0,d=c.fromCloudStructure(b),e=c.find(a.id),d.time=c.cloudcache[a.id].time,e.updateAttributes(d),window.currently_syncing=!1})},sync_all:function(b){var c=this;return log("syncs all the data, normally happens at the start of a program or coming back from offline"),window.current_syncing=new a(function(){return log("call back sync called"),window.current_syncing=new a(function(){window.current_syncing=null;if(b!=null)return b()}),c.sync_model_base_algo(),window.current_syncing.ready()}),this.load_all_from_cloud(),window.current_syncing.ready()},load_all_from_cloud:function(){var a,b=this;log("loads all the data from the cloud locally, probably not feasible with dropbox and changes need to happen"),this.cloudcache={};try{return Nimbus.Client.Dropbox.getMetadataList("/"+Nimbus.Auth.app_name+"/"+this.name,function(a){var c,d,e,f,g,h,i;log("call back load called"),log("data",a),h=a.contents,i=[];for(f=0,g=h.length;f<g;f++)e=h[f],d=e.path,c=d.replace("/"+Nimbus.Auth.app_name+"/"+(""+b.name+"/"),"").replace(".txt",""),i.push(b.cloudcache[c]={id:c,time:e.modified});return i},function(a){return console.log("ERROR: error called for metadataList, folder should be created"),Nimbus.Client.Dropbox.createFolder("/"+Nimbus.Auth.app_name+"/"+b.name,function(a){return log("call back create folder called",a)}),b.cloudcache={}})}catch(c){return a=c,log("trying to get the folder failed, probably cuz it don't exist",a)}},get_delta:function(){return log("get the delta for ",this.name," since last synced")},extended:function(){return this.sync(this.proxy(this.real_time_sync)),this.fetch(this.proxy(this.loadLocal))}},Nimbus.Auth.Dropbox_auth={authenticate_dropbox:function(){return localStorage.key=this.key,localStorage.secret=this.secret,localStorage.state="Auth",Nimbus.Client.Dropbox.get_request_token(this.key,this.secret,Nimbus.Client.Dropbox.authorize_token)},initialize_dropbox:function(){return log("initialization called"),location.protocol==="chrome-extension:"&&(log("Chrome edition authentication"),chrome.tabs.onUpdated.addListener(function(a,b,c){if(c.title==="API Request Authorized")return chrome.tabs.remove(a),Nimbus.Client.Dropbox.get_access_token(function(a){return localStorage.state="Working",Nimbus.Auth.authorized_callback!=null&&Nimbus.Auth.authorized_callback(),Nimbus.Auth.app_ready_func(),console.log("NimbusBase is working! Chrome edition."),Nimbus.track.registered_user()})})),localStorage["state"]!=null&&localStorage.state==="Auth"?Nimbus.Client.Dropbox.get_access_token(function(a){return localStorage.state="Working",Nimbus.Auth.authorized_callback!=null&&Nimbus.Auth.authorized_callback(),Nimbus.Auth.app_ready_func(),console.log("NimbusBase is working!"),Nimbus.track.registered_user()}):Nimbus.Auth.app_ready_func()},dropbox_authorized:function(){return Nimbus.Auth.service==="Dropbox"?localStorage.state==="Working"?!0:!1:!1},logout_dropbox:function(a){var b,c,d;localStorage.clear();if(Nimbus.dictModel!=null){d=Nimbus.dictModel;for(b in d)c=d[b],c.records={}}this.sync_services!=null&&Nimbus.Auth.setup(this.sync_services);if(a!=null)return a()}},Nimbus.Client.Dropbox={get_request_token:function(a,b,c){var d,e;return e=new XMLHttpRequest,e.open("POST","https://api.dropbox.com/1/oauth/request_token",!0),d='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+a+'",oauth_signature="'+b+'&"',log(d),e.setRequestHeader("Authorization",d),e.onreadystatechange=function(){var a,b,d,e,f,g,h,i,j,k;if(this.readyState===4){if(this.status!==200){try{h=JSON.parse(h)}catch(l){}return error(h,this.status,this)}a=this.response,log(a),f=a.split(/&/),g={};for(j=0,k=f.length;j<k;j++)b=f[j],e=b.split(RegExp("="),2),g[e[0]]=e[1];log("Token result",g);for(d in g)i=g[d],localStorage[d]=i;window.request_token=g;if(c!=null)return c(g)}},e.send()},authorize_token:function(a){var b,c,d;return log("authorize url",document.URL),document.URL.slice(0,4)==="file"&&typeof cordova!="undefined"&&cordova!==null?(log("Phonegap login"),b="https://www.dropbox.com/1/oauth/authorize?oauth_token="+a.oauth_token,c=window.open(b,"_blank","location=yes"),window.ref=c,window.auth_count=0,c.addEventListener("loadstop",function(a){console.log(a),console.log("event",a.url.indexOf("https://www.dropbox.com/1/oauth/authorize"));if(a.url.indexOf("https://www.dropbox.com/1/oauth/authorize")>=0){window.auth_count=window.auth_count+1;if(window.auth_count===2)return Nimbus.Auth.Dropbox_auth.initialize_dropbox(),window.ref.close()}}),c.addEventListener("exit",function(a){return Nimbus.Auth.logout_dropbox()})):document.URL.slice(0,4)==="http"?(d="&oauth_callback="+encodeURIComponent(document.URL),b="https://www.dropbox.com/1/oauth/authorize?oauth_token="+a.oauth_token+d,location.replace(b)):document.URL.slice(0,6)==="chrome"?(log("chrome app!"),b="https://www.dropbox.com/1/oauth/authorize?oauth_token="+a.oauth_token,chrome.tabs.create({url:b,selected:!0},function(a){return log("tab created",a.id)})):(b="https://www.dropbox.com/1/oauth/authorize?oauth_token="+a.oauth_token,location.replace(b))},get_access_token:function(a){var b,c,d,e;return c=localStorage.oauth_token,d=localStorage.oauth_token_secret,b='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+Nimbus.Auth.key+'",oauth_token="'+c+'",oauth_signature="'+Nimbus.Auth.secret+"&"+d+'"',log("auth_string:",b),e=new XMLHttpRequest,e.open("POST","https://api.dropbox.com/1/oauth/access_token",!0),e.setRequestHeader("Authorization",b),e.onreadystatechange=function(){var b,c,d,e,f,g,h,i,j,k;if(this.readyState===4){if(this.status!==200){try{h=JSON.parse(h)}catch(l){}return log(h,this.status,this)}c=this.response,log(c),g=c.split(/&/),b={};for(j=0,k=g.length;j<k;j++)d=g[j],f=d.split(RegExp("="),2),b[f[0]]=f[1];log("Access result",b);for(e in b)i=b[e],localStorage[e]=i;window.access_token=b;if(a!=null)return a(b)}},e.send()},send_request:function(a,b,c,d,e){var f,g,h,i,j,k;h=localStorage.oauth_token,i=localStorage.oauth_token_secret,f='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+Nimbus.Auth.key+'",oauth_token="'+h+'",oauth_signature="'+Nimbus.Auth.secret+"&"+i+'"',log("auth_string:",f),k=new XMLHttpRequest,k.open(a,b,!0),k.setRequestHeader("Authorization",f),k.onreadystatechange=function(){var a;if(this.readyState===4){if(this.status===200){a=this.response;try{a=JSON.parse(a)}catch(b){}log("REQUEST RESULT",a),d!=null&&d(a)}else{try{a=JSON.parse(a)}catch(b){}log(a,this.status,this),e!=null&&e(a)}if(window.current_syncing!=null)return window.current_syncing.ok()}};if(a==="POST"){k.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(c){j=[];for(g in c)j.push(encodeURIComponent(g)+"="+encodeURIComponent(c[g]));c=j.length>0?j.join("&").replace(/%20/g,"+"):null}log(c)}return log("send request params",a,b,c,d,e),window.current_syncing!=null&&window.current_syncing.wait(),k.send(c),window.xhr=k},send_request_without_delay:function(a,b,c,d,e){var f,g,h,i,j,k;h=localStorage.oauth_token,i=localStorage.oauth_token_secret,f='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+Nimbus.Auth.key+'",oauth_token="'+h+'",oauth_signature="'+Nimbus.Auth.secret+"&"+i+'"',log("auth_string:",f),k=new XMLHttpRequest,k.open(a,b,!0),k.setRequestHeader("Authorization",f),k.onreadystatechange=function(){var a;if(this.readyState===4)if(this.status===200){a=this.response;try{a=JSON.parse(a)}catch(b){}log("REQUEST RESULT",a);if(d!=null)return d(a)}else{try{a=JSON.parse(a)}catch(b){}log(a,this.status,this);if(e!=null)return e(a)}};if(a==="POST"){k.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(c){j=[];for(g in c)j.push(encodeURIComponent(g)+"="+encodeURIComponent(c[g]));c=j.length>0?j.join("&").replace(/%20/g,"+"):null}log(c)}return log("send request params",a,b,c,d,e),k.send(c)},putFileContents:function(a,b,c,d){return log("putFileContents"),Nimbus.Client.Dropbox.send_request("PUT","https://api-content.dropbox.com/1/files_put/sandbox"+a,b,c,d)},createFolder:function(a,b,c){return log("createFolder"),Nimbus.Client.Dropbox.send_request("POST","https://api.dropbox.com/1/fileops/create_folder",{root:"sandbox",path:a},b,c)},deletePath:function(a,b,c){return log("deletePath"),Nimbus.Client.Dropbox.send_request("POST","https://api.dropbox.com/1/fileops/delete",{root:"sandbox",path:a},b,c)},getFileContents:function(a,b,c){return log("getFileContents"),Nimbus.Client.Dropbox.send_request("GET","https://api-content.dropbox.com/1/files/sandbox"+a,"",b,c)},getMetadataList:function(a,b,c){return log("getMetadataList"),Nimbus.Client.Dropbox.send_request("GET","https://api.dropbox.com/1/metadata/sandbox"+a,"",b,c)},getAccountInfo:function(a,b){return log("getAccountInfo"),Nimbus.Client.Dropbox.send_request_without_delay("GET","https://api.dropbox.com/1/account/info","",a,b)}},window.client=null,Nimbus.Client.Dropbox.Binary={binary_setup:function(){return window.binary=Nimbus.Model.setup("binary",["name","path","copied","directlink","sharelink","expiration"])},initialize_client:function(){log("initializing second client");if(Nimbus.Auth.key==null)return log("can't upload file with no dropbox credentials");if(window.client==null)return window.client=new c.Client({key:Nimbus.Auth.key,secret:Nimbus.Auth.secret,sandbox:!0}),window.client.oauth.setToken(localStorage.oauth_token,localStorage.oauth_token_secret)},upload_blob:function(a,b,c){var d,e;return log("upload new blob"),Nimbus.Client.Dropbox.Binary.initialize_client(),window.client!=null?(e=binary.create({name:b,copied:!1}),d=function(a,b){console.log("wrote file to cloud"),console.log(a,b),e.copied=!0,e.path=b.path,e.save();if(c!=null)return c(e)},log("file name",b),window.client.writeFile(b,a,d)):log("client won't initialize")},upload_file:function(a,b){var c,d;return log("upload new file"),Nimbus.Client.Dropbox.Binary.initialize_client(),window.client!=null?(d=binary.create({name:a.name,copied:!1}),c=function(a,c){console.log("wrote file to cloud"),console.log(a,c),d.copied=!0,d.path=c.path,d.save();if(b!=null)return b(d)},log("file name",a.name),window.client.writeFile(a.name,a,c)):log("client won't initialize")},read_file:function(a,b){var c;return log("read a binary file from the server"),Nimbus.Client.Dropbox.Binary.initialize_client(),window.client!=null?(c=function(a,c,d){return console.log(a,c,d),b(c)},window.client.readFile(a.path,{blob:!0},c)):log("client won't initialize")},share_link:function(a,b){var c;log("get the share link"),Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null)return c=function(c,d){return console.log(c,d),a.sharelink=d.url,a.save(),b(d)},console.log(a.path),window.client.makeUrl(a.path,{},c)},direct_link:function(a,b){var c;log("get the share link"),Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null)return a.directlink!=null&&new Date(a.expiration)>new Date?b({url:a.directlink,expiresAt:a.expiration}):(c=function(c,d){return console.log(c,d),a.directlink=d.url,a.expiration=d.expiresAt.toString(),a.save(),b(d)},window.client.makeUrl(a.path,{download:!0,downloadHack:!0},c))},delete_file:function(a){var b;return log("delete file"),Nimbus.Client.Dropbox.Binary.initialize_client(),window.client!=null?(b=function(b,c){return a.destroy()},window.client.remove(a.path,b)):log("client won't initialize")}},Nimbus.Client.GDrive={check_auth:function(){var a;return log("checking if this is authenticated"),location.protocol==="chrome-extension:"&&gapi.auth.getToken()===null?(a=Nimbus.Auth.GDrive.getLocalOauth2Token(),a==null||Nimbus.Auth.GDrive.isTokenExpires(a)?!1:(gapi.auth.setToken(a),!0)):typeof gapi!="undefined"&&gapi!==null&&gapi.auth!=null&&gapi.auth.getToken()!==null},authorize:function(a,b,c){return log("authorized called"),gapi.auth.authorize({client_id:a,scope:b,immediate:!1},c)},insertFile:function(a,b,c,d,e){var f,g,h,i,j,k,l;return log("putFileContents"),g="-------314159265358979323846",i="\r\n--"+g+"\r\n",h="\r\n--"+g+"--",f=u(a),j={title:b,mimeType:c},d!=null&&(j.parents=[{kind:"drive#fileLink",id:d}]),k=i+"Content-Type: application/json\r\n\r\n"+JSON.stringify(j)+i+"Content-Type: "+c+"\r\n"+"Content-Transfer-Encoding: base64\r\n"+"\r\n"+f+h,log("MULTI: ",k),e||(e=function(a){return log("Update Complete ",a)}),l={path:"/upload/drive/v2/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+g+'"'},body:k},this.make_request(l,e)},deleteFile:function(a,b){var c,d=this;return log("deletePath"),b||(b=function(b){var c;return c={path:"/drive/v2/files/"+a,method:"DELETE"},d.make_request(c,function(a){return log("delete complete",a)}),log("Delete Complete ",b)}),c={path:"/drive/v2/files/"+a+"/trash",method:"POST"},this.make_request(c,b)},getFile:function(a,b){var c;return log("getFileContents"),b||(b=function(a){return log("Read Complete ",a)}),c={path:"/drive/v2/files/"+a,method:"GET"},this.make_request(c,b)},readFile:function(a,b){var c,d;return b||(b=function(a){return log("Read Complete ",a)}),c=gapi.auth.getToken().access_token,d=new XMLHttpRequest,d.open("GET",a),d.setRequestHeader("Authorization","Bearer "+c),d.onload=function(
){b(d.responseText);if(window.current_syncing!=null)return window.current_syncing.ok()},d.onerror=function(){return b(null)},window.current_syncing!=null&&window.current_syncing.wait(),d.send()},updateFile:function(a,b,c,d,e,f){var g,h,i,j,k,l,m;return log("updateFileContents"),h="-------314159265358979323846",j="\r\n--"+h+"\r\n",i="\r\n--"+h+"--",c="text/html",k={mimeType:c},g=u(a),k={title:b,mimeType:c},l=j+"Content-Type: application/json\r\n\r\n"+JSON.stringify(k)+j+"Content-Type: "+c+"\r\n"+"Content-Transfer-Encoding: base64\r\n"+"\r\n"+g+i,f||(f=function(a){return log("Update Complete ",a)}),m={path:"/upload/drive/v2/files/"+d,method:"PUT",params:{fileId:d,uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+h+'"'},body:l},this.make_request(m,f)},getMetadataList:function(a,b){var c;return log("getMetadataList"),b||(b=function(a){return log("List of files",a)}),c={path:"/drive/v2/files",method:"GET",params:{q:a}},this.make_request(c,b)},make_request:function(a,b){return a.callback=function(a){b!=null&&b(a);if(window.current_syncing!=null)return window.current_syncing.ok()},window.current_syncing!=null&&window.current_syncing.wait(),gapi.client.request(a)},get_current_user:function(a){var b,c,d=this;return log("get current user"),c=function(b){var c;log("About called ",b),c={},c.name=b.user.displayName,c.id=b.user.permissionId,b["user"].picture!=null&&(c.pic=b.user.picture.url);if(a!=null)return a(c)},b={path:"/drive/v2/about",method:"GET"},this.make_request(b,c)},add_share_user:function(a,b){var c,d,e,f=this;return log("&&& add share user"),e=function(a){var c;log("Add Share user Complete ",a),c={id:a.id,name:a.name,role:a.role},a.photoLink!=null&&(c.pic=a.photoLink);if(b!=null)return b(c)},c=window.folder[Nimbus.Auth.app_name].id,d={path:"/drive/v2/files/"+c+"/permissions",method:"POST",params:{fileId:c},body:{role:"writer",type:"user",value:a}},this.make_request(d,e)},remove_share_user:function(a,b){var c,d;return log("&&& remove a user from sharing this app"),c=window.folder[Nimbus.Auth.app_name].id,b||(b=function(a){return log("Permission Removal Complete ",a)}),d={path:"/drive/v2/files/"+c+"/permissions/"+a,method:"DELETE"},this.make_request(d,b)},get_user_email:function(){var a,b,c;return window.user_email!=null?window.user_email:(a=gapi.auth.getToken().access_token,b=null,c=new XMLHttpRequest,c.onreadystatechange=function(){if(c.readyState===4)return c.status===200?b=JSON.parse(c.responseText):log("get user email failed with status "+c.status)},c.open("GET","https://www.googleapis.com/oauth2/v1/tokeninfo?access_token="+a,!1),c.send(null),(b!=null?b.email:void 0)!=null?(window.user_email=b.email,b.email):null)},get_shared_users:function(a){var b,c,d,e=this;return log("&&& get shared users"),b=window.folder[Nimbus.Auth.app_name].id,d=function(b){var c,d,e,f,g,h;log("Update Complete ",b),e=[],h=b.items;for(f=0,g=h.length;f<g;f++)c=h[f],d={id:c.id,name:c.name,role:c.role},c.photoLink!=null&&(d.pic=c.photoLink),e.push(d);log("permissions",e);if(a!=null)return a(e)},c={path:"/drive/v2/files/"+b+"/permissions",method:"GET"},this.make_request(c,d)},get_app_folders:function(a){return log("&&& get app folders"),Nimbus.Client.GDrive.getMetadataList("mimeType = 'application/vnd.google-apps.folder' and title = '"+Nimbus.Auth.app_name+"'",function(b){var c,d,e,f,g,h;log(b),d=b.items,f=[];if(b.items!=null)for(g=0,h=d.length;g<h;g++)c=d[g],e={},e.id=c.id,e.owner=c.ownerNames[0],f.push(e);log(f);if(a!=null)return a(f)})},switch_to_app_folder:function(b,c){var d=this;return log("###switch to app folder"),window.folder={},window.folder[Nimbus.Auth.app_name]={title:Nimbus.Auth.app_name,id:b},window.current_syncing=new a(function(){if(c!=null)return c()}),localStorage.main_folder_id=b,Nimbus.Client.GDrive.getMetadataList("mimeType = 'application/vnd.google-apps.folder'",function(a){var c,d,e,f,g,h,i,j;c=a.items,log("###rewriting folders",c);for(g=0,h=c.length;g<h;g++)f=c[g],log(f),f.parents.length>0&&f.parents[0].id===b&&(window.folder[f.title]=f);if(Nimbus.dictModel!=null){i=Nimbus.dictModel,j=[];for(d in i)e=i[d],j.push(e.records={});return j}}),window.current_syncing.ready()},build_params:function(a){var b,c,d;return c=function(){var c;c=[];for(b in a)d=a[b],c.push(""+encodeURIComponent(b)+"="+encodeURIComponent(d));return c}(),c.join("&")},extract_params_from_url:function(){var a,b,c,d;b={},c=location.hash.substring(1),d=/([^&=]+)=([^&]*)/g;while(a=d.exec(c))b[decodeURIComponent(a[1])]=decodeURIComponent(a[2]);return b},request_access_token:function(){var a,b,c;return a={response_type:"token",client_id:Nimbus.Auth.key,redirect_uri:window.location.href,scope:Nimbus.Auth.secret,state:"gdrive_get_access_token",approval_prompt:"auto"},b=this.build_params(a),c="https://accounts.google.com/o/oauth2/auth?"+b,window.open(c,"_self")},request_validate_token:function(a){var b,c;return c=new XMLHttpRequest,b=null,c.onreadystatechange=function(){var a;if(c.readyState===4)return(a=c.status)===200||a===400?b=JSON.parse(c.responseText):log("validate access token failed with status "+c.status)},c.open("GET","https://www.googleapis.com/oauth2/v1/tokeninfo?access_token="+a,!1),c.send(null),b},is_token_validate:function(a){var b,c;return c=!1,b=this.request_validate_token(a),b==null?!1:(!("error"in b)&&(b!=null?b.audience:void 0)===Nimbus.Auth.key&&(c=!0),c)},handle_auth_redirected:function(){return typeof history.replaceState=="function"?history.replaceState("",document.title,window.location.pathname):void 0},is_auth_redirected:function(){var a;return a=this.extract_params_from_url(),a.state==="gdrive_get_access_token"&&"token_type"in a&&a.token_type==="Bearer"?!0:!1}},Nimbus.Client.GDrive.Binary={binary_setup:function(){return window.binary=Nimbus.Model.setup("binary",["name","path","copied","directlink","sharelink","expiration","file_id"])},initialize_client:function(a){log("initializing client");if(Nimbus.Auth.key==null||Nimbus.Auth.secret==null)return log("can't upload file with no GDrive credentials");if(!Nimbus.Client.GDrive.check_auth())return Nimbus.Client.GDrive.authorize(Nimbus.Auth.key,Nimbus.Auth.secret,function(){log("GDrive authorized");if(a)return a()});if(a)return a()},upload_blob:function(a,b,c){return Nimbus.Client.GDrive.Binary.initialize_client(function(){var d;return log("upload new blob"),d=new FileReader,d.readAsBinaryString(a),d.onload=function(){var e,f,g,h,i;return f=d.result,g=a.type||"application/octet-stream",i=window.folder.binary_files.id,h=binary.create({name:b}),e=function(a){console.log("upload file to cloud"),console.log(a),h.copied=!0,h.file_id=a.id,h.directlink=a.webContentLink,h.save();if(c!=null)return c(h)},Nimbus.Client.GDrive.insertFile(f,b,g,i,e)}})},upload_file:function(a,b){return Nimbus.Client.GDrive.Binary.initialize_client(function(){var c;return log("upload new file"),c=new FileReader,c.readAsBinaryString(a),c.onload=function(){var d,e,f,g,h,i;return g=a.name,e=c.result,f=a.type||"application/octet-stream",i=window.folder.binary_files.id,h=binary.create({name:g}),d=function(a){console.log("upload file to cloud"),console.log(a),h.copied=!0,h.file_id=a.id,h.directlink=a.webContentLink,h.save();if(b!=null)return b(h)},Nimbus.Client.GDrive.insertFile(e,g,f,i,d)}})},read_file:function(a,b){return Nimbus.Client.GDrive.Binary.initialize_client(function(){var c;return log("read metadata of a file from the server"),c={path:"/drive/v2/files/"+a.file_id},Nimbus.Client.GDrive.make_request(c,function(a){console.log(a);if(b)return b(a)})})},share_link:function(a,b){return Nimbus.Client.GDrive.Binary.initialize_client(function(){log("get the share link");if(b)return b("")})},direct_link:function(a,b){return Nimbus.Client.GDrive.Binary.initialize_client(function(){log("get the direct link");if(b)return b(a.directlink)})},delete_file:function(a){return Nimbus.Client.GDrive.Binary.initialize_client(function(){return log("delete file",a),Nimbus.Client.GDrive.deleteFile(a.file_id,function(){return a.destroy()})})}},window.nimbus_error=[],Nimbus.Model.GDrive={cloudcache:{},last_hash:"",hash:"",toCloudStructure:function(a){return log("local to cloud structure"),JSON.stringify(a)},fromCloudStructure:function(a){return log("changes cloud to local data in the form a dictionary"),JSON.parse(a)},diff_objects:function(a,b){var c,d,e;c={};for(d in a)e=a[d],b[d]!==a[d]&&(c[d]=[b[d],a[d]]);return a["parent_id"]!=null!=(b["parent_id"]!=null)&&(c.parent_id=["one of them is null"]),c},add_to_cloud:function(a,b){var c,d;return log("add to cloud",a),d=a.parent.name,c=window.folder[d].id,Nimbus.Client.GDrive.insertFile(this.toCloudStructure(a),a.id,"text/plain",c,function(b){return log("logging data inserted",b),window.currently_syncing=!0,a.gid=b.id,a.time=b.modifiedDate,a.synced=!0,a.save(),window.currently_syncing=!1})},delete_from_cloud:function(a,b){return log("delete from cloud",a),Nimbus.Client.GDrive.getMetadataList("title = '"+a+"'",function(a){var c;log("data",a);if(!(a.items.length>0))return log("file to be deleted not there");c=a.items[0].id,Nimbus.Client.GDrive.deleteFile(c);if(b!=null)return b()})},update_to_cloud:function(a,b){var c,d,e,f,g=this;return log("updated to cloud",a.name),e=a.parent.name,d=window.folder[e].id,f=function(b){return log("logging data inserted",b),window.currently_syncing=!0,a.time=b.modifiedDate,a.save(),a.synced=!0,window.currently_syncing=!1},c=function(b){var c;return c=b.items[0].id,Nimbus.Client.GDrive.updateFile(g.toCloudStructure(a),a.id,"text/plain",c,d,function(b){return log("logging data inserted",b),window.currently_syncing=!0,a.time=b.modifiedDate,a.save(),window.currently_syncing=!1})},a.gid!=null?Nimbus.Client.GDrive.updateFile(this.toCloudStructure(a),a.id,"text/plain",a.gid,d,function(b){return log("logging data updated",b),window.currently_syncing=!0,a.time=b.modifiedDate,a.save(),window.currently_syncing=!1}):Nimbus.Client.GDrive.getMetadataList("title = '"+a.id+"'",c)},add_from_cloud:function(a,b){var c,d=this;return log("add from cloud GDrive",a),c=function(b){var c,e;return log("cloud url data",JSON.parse(b)),window.currently_syncing=!0,c=d.fromCloudStructure(b),e=d.init(c),e.synced=!0,e.time=d.cloudcache[a].time,e.save(),window.currently_syncing=!1},Nimbus.Client.GDrive.getMetadataList("title = '"+a+"'",function(a){var b;return log("cloud read data",a),window.data=a,a.items!=null&&a.items.length>=1?(b=window.data.items[0].downloadUrl,Nimbus.Client.GDrive.readFile(b,c)):log("This data is not there")})},update_to_local:function(a,b){var c,d=this;return log("update to local",a),c=function(b){var c,e;return log("cloud url data",JSON.parse(b)),window.currently_syncing=!0,c=d.fromCloudStructure(b),e=d.find(a.id),c.time=d.cloudcache[a.id].time,e.updateAttributes(c),window.currently_syncing=!1},Nimbus.Client.GDrive.getMetadataList("title = '"+a.id+"'",function(b){var d;return log("cloud read data",b),window.data=b,b.error!=null?(window.nimbus_error.push({error:b.error,object:a}),console.log("##ERROR writing back to local",b.error,"object: ",a)):b.items.length>=1?(d=window.data.items[0].downloadUrl,Nimbus.Client.GDrive.readFile(d,c)):log("This data is not there")})},sync_all:function(b){var c=this;return log("syncs all the data, normally happens at the start of a program or coming back from offline"),window.current_syncing=new a(function(){return log("call back sync called"),window.current_syncing=new a(function(){window.current_syncing=null;if(b!=null)return b()}),c.sync_model_base_algo(),window.current_syncing.ready()}),this.load_all_from_cloud(),window.current_syncing.ready()},load_all_from_cloud:function(){var a,b,c,d=this;return log("loads all the data from the cloud locally"),this.cloudcache={},c=this.name,log("object name",c),window.folder!=null&&window.folder[c]!=null?(b=window.folder[c].id,a=function(a){var b,e,f,g,h;log("cloud read data",c,a),window.data=a;if(a.items!=null){g=a.items,h=[];for(e=0,f=g.length;e<f;e++)b=g[e],d.cloudcache[b.title]={id:b.title,time:b.modifiedDate},b.labels.trashed?h.push(console.log("##### this is trashed #####",b)):h.push(void 0);return h}return log("###ERROR, no return data")},Nimbus.Client.GDrive.getMetadataList("'"+b+"' in parents",a)):log("############################BIG ERROR no folder there for load from cloud")},get_delta:function(){return log("get the delta for ",this.name," since last synced")},extended:function(){return this.sync(this.proxy(this.real_time_sync)),this.fetch(this.proxy(this.loadLocal))}},window.folder=null,window.folder_creation=new j,window.creating={},window.handle_initialization=new j,window.gdrive_initialized=!1,window.folder_initialize=function(a){log("&&& folder initialize"),log("Nimbus.Client.GDrive.check_auth()",Nimbus.Client.GDrive.check_auth(),"Nimbus.Auth.service",Nimbus.Auth.service);if(Nimbus.Client.GDrive.check_auth()&&Nimbus.Auth.service==="GDrive")return log("this is authenticated and a GDrive app"),Nimbus.Client.GDrive.getMetadataList("mimeType = 'application/vnd.google-apps.folder'",function(b){var c,d,e,f,g,h;log("#data: ",b),window.folder===null&&(window.folder={}),c=b.items;if(localStorage["main_folder_id"]!=null)window.folder[Nimbus.Auth.app_name]={title:Nimbus.Auth.app_name,id:localStorage.main_folder_id};else for(e=0,g=c.length;e<g;e++)d=c[e],d.title===Nimbus.Auth.app_name&&(window.folder[d.title]=d);if(window.folder[Nimbus.Auth.app_name]==null)return window.folder={},Nimbus.Client.GDrive.insertFile("",Nimbus.Auth.app_name,"application/vnd.google-apps.folder",null,function(b){log("folder data",b),window.folder[b.title]=b,a!=null&&a();if(window.folder["binary_files"]==null)return Nimbus.Client.GDrive.insertFile("","binary_files","application/vnd.google-apps.folder",window.folder[Nimbus.Auth.app_name].id,function(a){log("binary_files folder data",a),log("binary ready callback",binary_ready_callback);if(window.binary_ready_callback)return window.binary_ready_callback()});log("binary ready callback",binary_ready_callback);if(window.binary_ready_callback)return window.binary_ready_callback()});log("base folder there: ",window.folder[Nimbus.Auth.app_name].id);for(f=0,h=c.length;f<h;f++)d=c[f],log(d),d.parents.length>0&&d.parents[0].id===window.folder[Nimbus.Auth.app_name].id&&(window.folder[d.title]=d);a!=null&&a();if(window.folder["binary_files"]==null)return Nimbus.Client.GDrive.insertFile("","binary_files","application/vnd.google-apps.folder",window.folder[Nimbus.Auth.app_name].id,function(a){log("binary_files folder data",a),log("binary ready callback",binary_ready_callback);if(window.binary_ready_callback)return window.binary_ready_callback()});log("binary ready callback",binary_ready_callback);if(window.binary_ready_callback)return window.binary_ready_callback()})},window.model_initialize=function(a){log("initialized model",a),log("#loaded",window.loaded,window.gdrive_initialized);if(!Nimbus.loaded||!Nimbus.Client.GDrive.check_auth()){log("initialization called later"),window.handle_initialization.add_call(function(){return window.model_initialize(a)});return}if(window.folder!==null)return window.folder[a.name]!=null?log("model folder there"):(log("creating model folder for",a.name),Nimbus.Client.GDrive.insertFile("",a.name,"application/vnd.google-apps.folder",window.folder[Nimbus.Auth.app_name].id,function(a){return window.folder[a.title]=a}));log("window.folder object not present"),log("#folder creation is running",window.folder_creation.running);if(window.creating[a.name]==null)return window.creating[a.name]=!0,window.folder_creation.running===!1&&window.folder_initialize(function(){return window.folder_creation.execute_callback()}),window.folder_creation.add_call(function(){log("THE CALLBACK IS CALLED","model.name exists",window.folder[a.name]!=null);if(window.folder[a.name]==null)return Nimbus.Client.GDrive.insertFile("",a.name,"application/vnd.google-apps.folder",window.folder[Nimbus.Auth.app_name].id,function(a){return window.folder[a.title]=a})})},Nimbus.Auth.GDrive={get_token_from_code:function(a){var b,c,d=this;return c=new XMLHttpRequest,b="code="+a+"&client_id="+this.key+"&client_secret="+this.client_secret+"&grant_type=authorization_code&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob",window.data=b,c.open("POST","https://accounts.google.com/o/oauth2/token"),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.onreadystatechange=function(a,b){if(c.readyState===4)try{return console.log("xhr",c),console.log("TOKEN RETRIEVAL LOGGED"),console.log("response: ",c.response)}catch(d){}},c.send(b),window.xhr=c},authenticate_gdrive:function(){var b,c;return log("this should bring up a prompt to initialize into GDrive"),localStorage.d_key=this.key,localStorage.secret=this.secret,localStorage.state="Auth",document.URL.slice(0,4)==="file"&&typeof cordova!="undefined"&&cordova!==null?(log("Phonegap google login"),b="https://accounts.google.com/o/oauth2/auth?response_type=token&client_id="+this.key+"&scope="+this.secret+"&approval_prompt=auto&redirect_uri=http%3A%2F%2Fnimbusbase.com",console.log(b),window.auth_url=b,c=window.open(b,"_blank","location=yes"),window.ref=c,c.addEventListener("loadstop",function(b){var c,d=this;console.log(b),console.log("event",b.url.indexOf("http://nimbusbase.com/"));if(b.url.indexOf("http://nimbusbase.com/")>=0)return c=b.url.split("access_token=")[1].split("&token_type")[0],gapi.auth.setToken({access_token:c,scope:"https://www.googleapis.com/auth/drive",client_id:localStorage.d_key}),window.binary_ready_callback=function(){if(Nimbus.Auth.authorized_callback!=null)return Nimbus.Auth.authorized_callback()},window.current_syncing=new a(function(){return log("CURRENT SYNCING CALLBACK"),Nimbus.Auth.app_ready_func()}),window.handle_initialization!=null&&window.handle_initialization.execute_callback(),window.current_syncing.ready(),window.ref.close(),Nimbus.track.registered_user()}),c.addEventListener("exit",function(a){return Nimbus.Auth.logout_gdrive()})):location.protocol==="chrome-extension:"?(log("chrome extension authorize"),this.oauth2_authorize()):Nimbus.Client.GDrive.request_access_token()},initialize_gdrive:function(){var a=this;log("This part should reflect what initialization needs to be done for GDrive auth"),Nimbus.gdrive_initialized=!0;if(Nimbus.loaded)return location.protocol==="chrome-extension:"?this.oauth2_authorize_second_half():(Nimbus.Client.GDrive.is_auth_redirected()&&Nimbus.Client.GDrive.handle_auth_redirected(),console.log("GDrive loaded"),gapi.auth.authorize({client_id:this.key,scope:this.secret,immediate:!0},function(b){log("client load handled GDrive"),log(b);if(b!==null)return a.prepare_gdrive()}))},gdrive_authorized:function(){return Nimbus.Client.GDrive.check_auth()},logout_gdrive:function(a){var b,c,d;localStorage.clear(),gapi.auth.setToken(null);if(Nimbus.dictModel!=null){d=Nimbus.dictModel;for(b in d)c=d[b],c.records={}}this.sync_services!=null&&Nimbus.Auth.setup(this.sync_services);if(a!=null)return a()},prepare_gdrive:function(){var b=this;return window.binary_ready_callback=function(){if(Nimbus.Auth.authorized_callback!=null)return Nimbus.Auth.authorized_callback()},window.current_syncing=new a(function(){return log("CURRENT SYNCING CALLBACK"),Nimbus.Auth.app_ready_func()}),window.handle_initialization!=null&&window.handle_initialization.execute_callback(),window.current_syncing.ready()},oauth2_authorize:function(){var a,b,c;return a=chrome.extension.getBackgroundPage(),a.NimbusAuth2=function(a){var b;return b={OAUTH2_REDIRECT_URI:"http://www.google.com/robots.txt",getExtensionId:function(){return a.chrome.i18n.getMessage("@@extension_id")},isOauth2AuthorizeRedirected:function(a,b){return a===this.OAUTH2_REDIRECT_URI&&b===this.getExtensionId()?!0:!1},parseParamsString:function(b){var c,d,e;d={},e=/([^&=]+)=([^&]*)/g;while(c=e.exec(b))d[a.decodeURIComponent(c[1])]=a.decodeURIComponent(c[2]);return d},parseRedirectedURL:function(a){var b,c,d,e;return e=a.split("#"),b=e[0],c=e[1],d=this.parseParamsString(c),{base_url:b,params:d}},generateRedirectListener:function(){var b,c=this;return b=function(d,e,f){var g,h,i,j,k;if(e.status!=="loading")return;h=c.parseRedirectedURL(f.url);if(c.isOauth2AuthorizeRedirected(h.base_url,h.params.state)){a.chrome.tabs.onUpdated.removeListener(b),a.chrome.tabs.remove(d),h.saved_time=(new a.Date).getTime(),a.localStorage._nimbusGDriveAuthObj=a.JSON.stringify(h);if(c.isPackagedApp()){a.console.log("in packaged app"),g=a.chrome.extension.getViews({type:"tab"});for(j=0,k=g.length;j<k;j++)i=g[j],i.Nimbus.Auth.GDrive.oauth_status_flag==="ongoing"&&i.Nimbus.Auth.GDrive.oauth2_authorize_second_half()}else c.isBrowserAction()&&a.console.log("in browser action");return null}},b},installRedirectedListener:function(){return a.chrome.tabs.onUpdated.addListener(this.generateRedirectListener())},isBrowserAction:function(){return"browser_action"in a.chrome.runtime.getManifest()},isPackagedApp:function(){return"app"in a.chrome.runtime.getManifest()}},b}(a),Nimbus.Auth.GDrive.oauth_status_flag="ongoing",a.NimbusAuth2.installRedirectedListener(),c="https://accounts.google.com/o/oauth2/auth?",b={client_id:this.key,scope:this.secret,redirect_uri:this.OAUTH2_REDIRECT_URI,state:this.getExtensionId(),response_type:"token",approval_prompt:"auto"},c+=this.buildParamsString(b),chrome.tabs.create({url:c})},oauth2_authorize_second_half:function(){var a,b,c,d;if(localStorage._nimbusGDriveAuthObj!=null){d=JSON.parse(localStorage._nimbusGDriveAuthObj);if("error"in d)throw new Error("authorization failed with error: "+d.error);b=d.params,a=Math.round(d.saved_time/1e3),b.client_id=this.key,b.scope=this.secret,b.response_type="token",b.issued_at=a.toString(),b.expires_at=(a+parseInt(b.expires_in)).toString(),b.state="",delete localStorage._nimbusGDriveAuthObj,localStorage._chromeExtensionAuth2Token=JSON.stringify(b)}if(localStorage._chromeExtensionAuth2Token)return c=JSON.parse(localStorage._chromeExtensionAuth2Token),gapi.auth.setToken(c),Nimbus.Auth.GDrive.oauth_status_flag="finish",this.prepare_gdrive()},OAUTH2_REDIRECT_URI:"http://www.google.com/robots.txt",getExtensionId:function(){return chrome.i18n.getMessage("@@extension_id")},buildParamsString:function(a){var b,c,d;return c=function(){var c;c=[];for(b in a)d=a[b],c.push(""+encodeURIComponent(b)+"="+encodeURIComponent(d));return c}(),c.join("&")},getLocalOauth2Token:function(a){return Nimbus.Auth.GDrive._cacheToken!=null?Nimbus.Auth.GDrive._cacheToken:localStorage._chromeExtensionAuth2Token!=null?(a=JSON.parse(localStorage._chromeExtensionAuth2Token),Nimbus.Auth.GDrive._cacheToken=a,a):null},isTokenExpires:function(a){var b,c;return(a!=null?a.expires_at:void 0)!=null?(b=parseInt(a.expires_at),c=(new Date).getTime(),b*1e3>c?!0:!1):!0}},Nimbus.Auth.Multi={authenticate_service:function(a){var b,c,d,e,f,g;log("authenticate a single service",a),b=Array.isArray||function(a){return{}.toString.call(a)==="[object Array]"};if(this.sync_services!=null&&this.sync_services[a]!=null){f=this.sync_services[a],a==="Dropbox"&&Nimbus.Auth.setup(a,f.key,f.secret,f.app_name),a==="GDrive"&&(d="https://www.googleapis.com/auth/userinfo.email",b(f.scope)?$.call(f.scope,d)<0&&f.scope.push(d):f.scope=[f.scope,d],f.scope=f.scope.join(" "),f.client_secret!=null?Nimbus.Auth.setup(a,f.key,f.scope,f.app_name,f.client_secret):Nimbus.Auth.setup(a,f.key,f.scope,f.app_name)),g=Nimbus.dictModel;for(c in g)e=g[c],Nimbus.Model.service_setup(e);return Nimbus.Auth.initialize(),Nimbus.Auth.authorize()}},initialize_service:function(){return log("initializing service")}},Nimbus.Auth.reinitialize(),Nimbus.backbone_store=function(a,b){var c,d,e,f,g,h,i;log("Model on creation",b),this.name=a,e=new b,d=[],i=e.attributes;for(c in i)h=i[c],d.push(c);return f=Nimbus.Model.setup(a,d),g=f,this.data=f.all()||{},g},Nimbus.backbone_sync=function(a,b,c){var d,e,f,g;e=void 0,g=b.nimbus||b.collection.nimbus,window.model=b;switch(a){case"read":if(b.id)e=g.find(b);else{g.sync_all(function(){return e=g.all(),c.success(e)});return}break;case"create":console.log("create called"),d=g.init(b.attributes),d.id=b.id,d.save(),e=d;break;case"update":f=g.find(b.id),f.updateAttributes(b.attributes),f.save(),e=f;break;case"delete":console.log("deletion find",g.find(b.id)),e=g.find(b.id).destroy()}return e?c.success(e):c.error("Record not found")},Nimbus.angularService=function(){var a,b,c;return a={},c=function(b,c,d){var e;return e=Nimbus.Model.setup(b,c),e.sync_all(d),a.name=e,e},b=function(a){return function(){return localStorage[a]}},{setup:c,makeWatcher:b}},"use strict",J=this;if(J.Base64)return;T="2.1.2",x=void 0,typeof module!="undefined"&&module.exports&&(x=require("buffer").Buffer),p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",q=function(a){var b,c,d;d={},b=0,c=a.length;while(b<c)d[a.charAt(b)]=b,b++;return d},p,I=String.fromCharCode,B=function(a){var b;return a.length<2?(b=a.charCodeAt(0),b<128?a:b<2048?I(192|b>>>6)+I(128|b&63):I(224|b>>>12&15)+I(128|b>>>6&63)+I(128|b&63)):(b=65536+(a.charCodeAt(0)-55296)*1024+(a.charCodeAt(1)-56320),I(240|b>>>18&7)+I(128|b>>>12&63)+I(128|b>>>6&63)+I(128|b&63))},O=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,S=function(a){return a.replace(O,B)},A=function(a){var b,c,d;return d=[0,2,1][a.length%3],c=a.charCodeAt(0)<<16|(a.length>1?a.charCodeAt(1):0)<<8|(a.length>2?a.charCodeAt(2):0),b=[p.charAt(c>>>18),p.charAt(c>>>12&63),d>=2?"=":p.charAt(c>>>6&63),d>=1?"=":p.charAt(c&63)],b.join("")},u=J.btoa||function(a){return a.replace(/[\s\S]{1,3}/g,A)},W=x?function(a){return(new x(a)).toString("base64")}:function(a){return u(S(a))},F=function(a,b){return b?W(a).replace(/[+\/]/g,function(a){return a==="+"?"-":"_"}).replace(RegExp("=","g"),""):W(a)},G=function(a){return F(a,!0)},N=N=new RegExp(["[-][-]","[-][-]{2}","[-][-]{3}"].join("|"),"g"),y=function(a){var b,c;switch(a.length){case 4:return b=(7&a.charCodeAt(0))<<18|(63&a.charCodeAt(1))<<12|(63&a.charCodeAt(2))<<6|63&a.charCodeAt(3),c=b-65536,I((c>>>10)+55296)+I((c&1023)+56320);case 3:return I((15&a.charCodeAt(0))<<12|(63&a.charCodeAt(1))<<6|63&a.charCodeAt(2));default:return I((31&a.charCodeAt(0))<<6|63&a.charCodeAt(1))}},w=function(a){return a.replace(N,y)},z=function(a){var b,c,d,e;return c=a.length,e=c%4,d=(c>0?q[a.charAt(0)]<<18:0)|(c>1?q[a.charAt(1)]<<12:0)|(c>2?q[a.charAt(2)]<<6:0)|(c>3?q[a.charAt(3)]:0),b=[I(d>>>16),I(d>>>8&255),I(d&255)],b.length-=[0,0,2,1][e],b.join("")},n=J.atob||function(a){return a.replace(/[\s\S]{1,4}/g,z)},V=x?function(a){return(new x(a,"base64")).toString()}:function(a){return w(n(a))},D=function(a){return V(a.replace(/[-_]/g,function(a){return a==="-"?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))},J.Base64={VERSION:T,atob:n,btoa:u,fromBase64:D,toBase64:F,utob:S,encode:F,encodeURI:G,btou:w,decode:D},typeof Object.defineProperty=="function"&&(M=function(a){return{value:a,enumerable:!1,writable:!0,configurable:!0}},J.Base64.extendString=function(){return Object.defineProperty(String.prototype,"fromBase64",M(function(){return D(this)})),Object.defineProperty(String.prototype,"toBase64",M(function(a){return F(this,a)})),Object.defineProperty(String.prototype,"toBase64URI",M(function(){return F(this,!0)}))}),L="57da9d172e8c2000bca77d9ebb935752",Nimbus.track={send_people_request:function(a){var b,c,d=this;return c=new XMLHttpRequest,log(JSON.stringify(a)),b=Base64.encode(JSON.stringify(a)),window.data="data="+b,c.open("POST","http://api.mixpanel.com/engage"),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.onreadystatechange=function(a,b){if(c.readyState===4)try{return log("xhr",c),log("mixpanel response done"),log("response: ",c.response)}catch(d){}},c.send(data),window.xhr=c},registered_user:function(){var a;log("registered user"),Nimbus.Auth.service==="Dropbox"&&Nimbus.Client.Dropbox.getAccountInfo(function(a){var b,c,d,e,f,g;return e=a.display_name,g=e.split(" "),c=g[0],d=g[1],b="",a.email!=null&&(b=a.email),f={$set:{$first_name:c,$last_name:d,$app:Nimbus.Auth.app_name,$service:Nimbus.Auth.service,$email:b,$url:window.location.href},$token:L,$distinct_id:b},log(f),Nimbus.track.send_people_request(f)});if(Nimbus.Auth.service==="GDrive")return a=Nimbus.Client.GDrive.get_user_email(),Nimbus.Client.GDrive.get_current_user(function(b){var c,d,e,f,g;return e=b.name,g=e.split(" "),c=g[0],d=g[1],f={$set:{$first_name:c,$last_name:d,$app:Nimbus.Auth.app_name,$service:Nimbus.Auth.service,$email:a,$url:window.location.href},$token:L,$distinct_id:a},log(f),Nimbus.track.send_people_request(f)})},report_storage_stat:function(){var a,b;return log("report storage stat"),b=new Date,localStorage["last_reported_date"]!=null&&(a=localStorage.last_reported_date),a?(b-a>864e5&&log("start sending data"),localStorage.last_reported_date=b):log("start sending data")}},this.Nimbus=Nimbus})).call(this);